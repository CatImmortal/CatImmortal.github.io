<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>CatLua开发总结 | 仙猫洞</title><meta name="keywords" content="编译原理,Lua"><meta name="author" content="自然妙有猫仙人"><meta name="copyright" content="自然妙有猫仙人"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="基于C#实现的简易Lua解释器">
<meta property="og:type" content="article">
<meta property="og:title" content="CatLua开发总结">
<meta property="og:url" content="http://www.cathole.top/2021/11/09/catlua-dev-summary/index.html">
<meta property="og:site_name" content="仙猫洞">
<meta property="og:description" content="基于C#实现的简易Lua解释器">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/CatLuaDevSummary/CatLuaDevSummary_1.png">
<meta property="article:published_time" content="2021-11-09T13:24:46.000Z">
<meta property="article:modified_time" content="2023-06-14T11:52:03.208Z">
<meta property="article:author" content="自然妙有猫仙人">
<meta property="article:tag" content="编译原理">
<meta property="article:tag" content="Lua">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/CatLuaDevSummary/CatLuaDevSummary_1.png"><link rel="shortcut icon" href="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/head2.png"><link rel="canonical" href="http://www.cathole.top/2021/11/09/catlua-dev-summary/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CatLua开发总结',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-06-14 19:52:03'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom/copyright.css"><link rel="stylesheet" href="/css/custom/index.7dde3304.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/head2.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">24</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">9</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/CatLuaDevSummary/CatLuaDevSummary_1.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">仙猫洞</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">CatLua开发总结</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-11-09T13:24:46.000Z" title="发表于 2021-11-09 21:24:46">2021-11-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-06-14T11:52:03.208Z" title="更新于 2023-06-14 19:52:03">2023-06-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%A8%8B%E5%BA%8F/">程序</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%A8%8B%E5%BA%8F/%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/">开发总结</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">8.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>32分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="CatLua开发总结"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>前段时间出于对Lua底层机制与编译原理的学习，笔者尝试写了个简易的Lua解释器<a target="_blank" rel="noopener" href="https://github.com/CatImmortal/CatLua">CatLua</a>，主要参考《自己动手实现Lua》（原书是Go语言实现，笔者选择了自己熟悉的C#语言，并且对原书很多地方的代码进行了符合自身审美的重构），其余则参考了《Lua设计与实现》、《Lua源码欣赏》</p>
<p>最终代码结构如下：</p>
<p><img src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/CatLuaDevSummary/CatLuaDevSummary_1.png"></p>
<ul>
<li>Chunk：包含保存读取到的Lua字节码信息的数据结构</li>
<li>Compiler：包含词法分析器（Lexer）、语法分析器（Parser）与函数原型编译器（Compiler）</li>
<li>Instruction：包含所有Lua虚拟机可执行的指令的定义与实现</li>
<li>LuaStack：包含用于Lua虚拟机进行数据操作、指令逻辑执行的Lua虚拟栈，以及Lua数据类型在C#层的对应实现</li>
<li>LuaState：包含核心Lua虚拟机，封装了大量对LuaStack的操作</li>
<li>Operator：包含运算符的定义与实现，包括数学运算、位运算、逻辑运算</li>
<li>StdLib：包含标准库的实现</li>
<li>Util：包含各类辅助代码</li>
</ul>
<p>此文主要用于对CatLua的总结以及各部分实现思路的梳理，因此不会对每一处细节都进行讲解，若欲详细了解可自行到Github下载源码</p>
<h1 id="Lua字节码读取"><a href="#Lua字节码读取" class="headerlink" title="Lua字节码读取"></a>Lua字节码读取</h1><p>在借助Lua官方的编译器的情况下，可以先跳过比较麻烦的编译器实现，而直接从字节码读取开始</p>
<h2 id="Chunk"><a href="#Chunk" class="headerlink" title="Chunk"></a>Chunk</h2><p>一般而言，一个Lua文件就被视为一个Chunk（严格意义上来说，任何一段可被Lua解释器执行的代码就是一个Chunk）</p>
<p>Chunk定义如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> lua的二进制字节码chunk</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Chunk</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 头信息</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> ChunkHeader Header;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 主函数的upvalue数量</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">byte</span> UpvaluesSize;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 主函数</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> FuncPrototype MainFunc;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 从字节流解码trunk</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Chunk <span class="title">Undump</span>(<span class="params"><span class="built_in">byte</span>[] data</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           Chunk chunk = <span class="keyword">new</span> Chunk();</span><br><span class="line">           ChunkReader reader = <span class="keyword">new</span> ChunkReader(data);</span><br><span class="line">           chunk.Header = reader.CheckHeader();</span><br><span class="line">           chunk.UpvaluesSize = reader.ReadByte();</span><br><span class="line">           chunk.MainFunc = reader.ReadProto(<span class="built_in">string</span>.Empty);</span><br><span class="line">           <span class="keyword">return</span> chunk;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><p>Chunk被视为自动拥有一个主函数，而在其中定义的任何变量与函数都会被处理为这个主函数内部定义的变量与子函数，因此执行一段Chunk总是从该Chunk的主函数开始执行的，</p>
<p><strong>这也就是为什么在Lua文件里不用定义“Main”函数，就可以直接执行里面的代码</strong></p>
<p>函数定义如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> 函数原型</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FuncPrototype</span></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 源文件名</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">string</span> Source;</span><br><span class="line"></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 起始行号</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">uint</span> LineDefined;</span><br><span class="line"></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 结束行号</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">uint</span> LastLineDefined;</span><br><span class="line"></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 固定参数个数</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">byte</span> NumParams;</span><br><span class="line"></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 是否有变长参数</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">byte</span> IsVararg;</span><br><span class="line"></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 寄存器数量</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">byte</span> MaxStackSize;</span><br><span class="line"></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 指令表</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">uint</span>[] Code;</span><br><span class="line"></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 常量表</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> LuaConstantUnion[] Constants;</span><br><span class="line"></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> upvalue表</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> UpvalueInfo[] UpvalueInfos;</span><br><span class="line"></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 子函数原型表</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> FuncPrototype[] Protos;</span><br><span class="line"></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 行号表（每条指令对应的行号）</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">uint</span>[] LineInfo;</span><br><span class="line"></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 局部变量表</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> LocalVarInfo[] Locvars;</span><br><span class="line"></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> upvalue名列表</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">string</span>[] UpvalueNames;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<p>可以看出函数的本质就是一系列的“<strong>指令</strong>”，此外FuncPrototype还记录了与此函数相关的信息，如参数个数，局部变量信息等</p>
<h1 id="指令"><a href="#指令" class="headerlink" title="指令"></a>指令</h1><p>Lua是一种<strong>面向虚拟机的编程语言</strong>（与此相对立的则是<strong>面向硬件的编程语言</strong>，如C/C++），依靠同一套指令集规范在不同实现的虚拟机上运行，达到<strong>跨平台与嵌入宿主语言作为脚本存在</strong>的效果</p>
<p>Lua在5.0前是基于栈的虚拟机，而在5.0开始改为了基于寄存器的虚拟机，二者的主要区别在于：</p>
<ul>
<li>基于栈的虚拟机只能使用push、pop来操作栈顶，因此需要的指令集较大，相同逻辑需要执行的指令较多，但是指令长度较短</li>
<li>基于寄存器的虚拟机可以直接对栈进行寻址（比如直接从栈底获取值，把栈顶倒数第n个值复制到栈顶等），所以需要的指令集较小，相同逻辑需要执行的指令较少，但由于需要把地址编码进指令中所以指令长度较长</li>
</ul>
<p>一般而言，虚拟机在执行指令时，采用的都是将一个巨大的对指令的Switch Case包裹在循环中来不断执行指令，比如Lua官方C版虚拟机：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">luaV_execute</span> <span class="params">(lua_State *L)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//.....省略</span></span><br><span class="line">    </span><br><span class="line">  <span class="comment">/* main loop of interpreter */</span></span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    Instruction i;</span><br><span class="line">    StkId ra;</span><br><span class="line">    vmfetch();</span><br><span class="line">    vmdispatch (GET_OPCODE(i)) &#123;</span><br><span class="line">      vmcase(OP_MOVE) &#123;</span><br><span class="line">        setobjs2s(L, ra, RB(i));</span><br><span class="line">        vmbreak;</span><br><span class="line">      &#125;</span><br><span class="line">      vmcase(OP_LOADK) &#123;</span><br><span class="line">        TValue *rb = k + GETARG_Bx(i);</span><br><span class="line">        setobj2s(L, ra, rb);</span><br><span class="line">        vmbreak;</span><br><span class="line">      &#125;</span><br><span class="line">      vmcase(OP_LOADKX) &#123;</span><br><span class="line">        TValue *rb;</span><br><span class="line">        lua_assert(GET_OPCODE(*ci-&gt;u.l.savedpc) == OP_EXTRAARG);</span><br><span class="line">        rb = k + GETARG_Ax(*ci-&gt;u.l.savedpc++);</span><br><span class="line">        setobj2s(L, ra, rb);</span><br><span class="line">        vmbreak;</span><br><span class="line">      &#125;</span><br><span class="line">     </span><br><span class="line">        <span class="comment">//省略...</span></span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>CatLua则是采用<strong>表驱动</strong>的写法，将Lua指令与其相关参数及其对应实现逻辑封装为一个InstructionConfig类，并放入数组里，根据指令码ID进行索引（运算符实现也与此类似，后续便不重复了）</p>
<p>Instruction定义如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> 指令</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Instructoin</span></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="title">Instructoin</span>(<span class="params"><span class="built_in">uint</span> code</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">this</span>.code = code;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//省略...</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 执行指令</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Execute</span>(<span class="params">LuaState vm</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">          Action&lt;Instructoin, LuaState&gt; function = InstructionConfig.Configs[OpCode].Func;</span><br><span class="line">          <span class="keyword">if</span> (function != <span class="literal">null</span>)</span><br><span class="line">          &#123;</span><br><span class="line">              function(<span class="keyword">this</span>, vm);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;指令没有对应的函数实现：&quot;</span> + OpType.ToString());</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<p>InstructionConfig定义如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> 指令配置</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">InstructionConfig</span></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="title">InstructionConfig</span>(<span class="params"><span class="built_in">byte</span> testFlag, <span class="built_in">byte</span> setAFlag, OpArgType argBType, OpArgType argCType, OpMode opMode, OpCodeType type, Action&lt;Instructoin, LuaState&gt; func = <span class="literal">null</span></span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">          TestFlag = testFlag;</span><br><span class="line">          SetAFlag = setAFlag;</span><br><span class="line">          ArgBType = argBType;</span><br><span class="line">          ArgCType = argCType;</span><br><span class="line">          OpMode = opMode;</span><br><span class="line">          Type = type;</span><br><span class="line">          Func = func;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//省略...</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 操作码类型</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> OpCodeType Type;</span><br><span class="line"></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 指令的函数实现</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> Action&lt;Instructoin, LuaState&gt; Func;</span><br><span class="line"></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 所有指令的指令配置</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">static</span> InstructionConfig[] Configs =</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">new</span> InstructionConfig(<span class="number">0</span>,<span class="number">1</span>,OpArgType.R,OpArgType.N,OpMode.IABC,OpCodeType.Move,InstructionFuncs.MoveFunc),</span><br><span class="line">          <span class="keyword">new</span> InstructionConfig(<span class="number">0</span>,<span class="number">1</span>,OpArgType.K,OpArgType.N,OpMode.IABx,OpCodeType.LoadK,InstructionFuncs.LoadKFunc),</span><br><span class="line">          <span class="keyword">new</span> InstructionConfig(<span class="number">0</span>,<span class="number">1</span>,OpArgType.N,OpArgType.N,OpMode.IABx,OpCodeType.LoadKX,InstructionFuncs.LoadKXFunc),</span><br><span class="line">          <span class="keyword">new</span> InstructionConfig(<span class="number">0</span>,<span class="number">1</span>,OpArgType.U,OpArgType.U,OpMode.IABC,OpCodeType.LoadBool,InstructionFuncs.LoadBoolFunc),</span><br><span class="line">	<span class="comment">//省略...</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<p>这样对指令的执行就变成了在循环中查表</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//不断取出指令执行</span></span><br><span class="line">	Instructoin i = <span class="keyword">new</span> Instructoin(Fetch());</span><br><span class="line">	i.Execute(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="优化建议"><a href="#优化建议" class="headerlink" title="优化建议"></a>优化建议</h3><p>尽量用局部变量缓存全局变量，避免对全局变量的频繁使用</p>
<p>因为对全局变量的访问相比对局部变量的访问需要更多的指令</p>
<h1 id="Lua数据类型"><a href="#Lua数据类型" class="headerlink" title="Lua数据类型"></a>Lua数据类型</h1><p>在整个虚拟机运行过程中，都是基于对Lua虚拟栈的操作来实现的，而栈中所保存的则是Lua内置的数据类型</p>
<p>Lua中有多种数据类型，如nil、布尔、数字、Table、函数等，这些数据类型在CatLua中都被统一封装为LuaDataUnion，其定义如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Lua数据的模拟Union</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> LuaDataUnion : IEqualityComparer&lt;LuaDataUnion&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//省略...</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> LuaDataType Type</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> Boolean</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">long</span> Integer</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">double</span> Number</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Str</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> LuaTable Table</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Closure Closure</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//省略...</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>其中比较重要的有Table和Closure（闭包），接下来将着重讲解这两者</p>
<h2 id="Table"><a href="#Table" class="headerlink" title="Table"></a>Table</h2><p>Table作为Lua中唯一的数据容器，可以说是十分万能的存在，其既能表现出数组的特性，又能表现出字典的特性，因此在CatLua中便直接使用了C#自带的数组和字典来实现Table，同时嵌套了一个Table来表示元表</p>
<p>LuaTable定义如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> Lua中的Table数据结构</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LuaTable</span></span><br><span class="line">  &#123;</span><br><span class="line">  	<span class="function"><span class="keyword">public</span> <span class="title">LuaTable</span>(<span class="params"><span class="built_in">int</span> arrSize = <span class="number">0</span>,<span class="built_in">int</span> dictSize = <span class="number">0</span></span>)</span></span><br><span class="line">      &#123;</span><br><span class="line"></span><br><span class="line">          arr = <span class="keyword">new</span> List&lt;LuaDataUnion&gt;(arrSize);</span><br><span class="line">          <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; arrSize; i++)</span><br><span class="line">          &#123;</span><br><span class="line">              arr.Add(<span class="literal">default</span>);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          dict = <span class="keyword">new</span> Dictionary&lt;LuaDataUnion, LuaDataUnion&gt;(dictSize);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 数组部分</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">private</span> List&lt;LuaDataUnion&gt; arr;</span><br><span class="line"></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 字典部分</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">private</span> Dictionary&lt;LuaDataUnion, LuaDataUnion&gt; dict;</span><br><span class="line"></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 元表</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> LuaTable MetaTable;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//省略...</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<h3 id="元表与元方法"><a href="#元表与元方法" class="headerlink" title="元表与元方法"></a>元表与元方法</h3><p>元表，即<strong>MetaTable</strong>，在Lua中起到的作用相当于其他语言中运算符重载功能，通过设置与之对应的元方法，开发者可以自定义对Table的一些操作，比如赋值（Index）、取值(newindex)、调用(call)等</p>
<p>虚拟机会在执行相关操作时检测元表中是否有对应元方法，若有则进行元方法的调用，而不再继续进行原本的处理了</p>
<h3 id="面向对象的实现"><a href="#面向对象的实现" class="headerlink" title="面向对象的实现"></a>面向对象的实现</h3><p>Lua OOP的实现思路有2种：</p>
<ol>
<li>通过设置子类index元方法为其父类，使得在子类中查找不到的成员会上溯至父类查找</li>
<li>直接将父类成员深拷贝给子类</li>
</ol>
<p>方法1在查找时需要一层层的网上找，有一定的性能损耗</p>
<p>方法2虽然查找快，但是在对象创建时会消耗更多内存</p>
<h3 id="插入与扩容"><a href="#插入与扩容" class="headerlink" title="插入与扩容"></a>插入与扩容</h3><p>CatLua在插入一个正整数key时，会先判断是否在数组长度内，若是，则放入数组中</p>
<p>否则继续检测是否只是刚好超出数组长度1位，若是，则放入数组触发扩容，扩容会导致将之前字典里存放的某些符合要求的正整数key的value值移动到数组部分</p>
<p>若上面的检测都不通过，则直接放入数组部分</p>
<p>详细源码如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (TryConvertToArrIndex(key, <span class="keyword">out</span> <span class="built_in">long</span> index) &amp;&amp; index &gt;= <span class="number">1</span>)</span><br><span class="line">               &#123;</span><br><span class="line">                   <span class="comment">//key是整数或者是可以转换为整数索引的浮点数 </span></span><br><span class="line"></span><br><span class="line">                   <span class="keyword">if</span> (index &lt;= arr.Count)</span><br><span class="line">                   &#123;</span><br><span class="line">                       <span class="comment">//在数组长度内 放入数组</span></span><br><span class="line">                       arr[(<span class="built_in">int</span>)index - <span class="number">1</span>] = <span class="keyword">value</span>;</span><br><span class="line"></span><br><span class="line">                       <span class="keyword">if</span> (index == arr.Count &amp;&amp; <span class="keyword">value</span>.Type == LuaDataType.Nil)</span><br><span class="line">                       &#123;</span><br><span class="line">                           <span class="comment">//value是个nil值 并且被放在数组的末尾 需要清理掉末尾的nil值</span></span><br><span class="line">                           RemoveArrTailNil();</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="keyword">return</span>;</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                   <span class="keyword">if</span> (index == arr.Count + <span class="number">1</span> &amp;&amp; <span class="keyword">value</span>.Type != LuaDataType.Nil)</span><br><span class="line">                   &#123;</span><br><span class="line">                       <span class="comment">//不在数组长度内 但只是刚刚超出1位 并且不是nil值</span></span><br><span class="line"></span><br><span class="line">                       <span class="comment">//可能之前存在字典里 先删掉</span></span><br><span class="line">                       <span class="keyword">if</span> (dict != <span class="literal">null</span>)</span><br><span class="line">                       &#123;</span><br><span class="line">                           dict.Remove(key);</span><br><span class="line">                       &#125;</span><br><span class="line">                       </span><br><span class="line"></span><br><span class="line">                       <span class="comment">//放入数组 触发扩容</span></span><br><span class="line">                       arr.Add(<span class="keyword">value</span>);</span><br><span class="line"></span><br><span class="line">                       <span class="comment">//将字典里的符合条件的整数key的value移动到扩容后的数组</span></span><br><span class="line">                       MoveDictToArr();</span><br><span class="line"></span><br><span class="line">                       <span class="keyword">return</span>;</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                   </span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="comment">//不能放进数组里 只能试试字典了</span></span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (<span class="keyword">value</span>.Type != LuaDataType.Nil)</span><br><span class="line">               &#123;</span><br><span class="line">                   <span class="comment">//value不是nil值 放入字典里</span></span><br><span class="line"></span><br><span class="line">                   dict[key] = <span class="keyword">value</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">else</span></span><br><span class="line">               &#123;</span><br><span class="line">                   <span class="comment">//value是个nil 删掉key</span></span><br><span class="line">                   dict.Remove(key);</span><br><span class="line">               &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 数组部分扩容后，将字典部分的某些值移动到数组里</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">MoveDictToArr</span>(<span class="params"></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (dict == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//将dict中从当前数组长度+1的连续整数key的value移动到数组部分</span></span><br><span class="line">            <span class="comment">//比如数组长度为3 就将字典里key分别为4,5,6,7....的value移动到数组</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">int</span> index = arr.Count + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                LuaDataUnion key = Factory.NewInteger(index);</span><br><span class="line">                <span class="keyword">if</span> (dict.TryGetValue(key, <span class="keyword">out</span> LuaDataUnion data))</span><br><span class="line">                &#123;</span><br><span class="line">                    arr.Add(data);</span><br><span class="line">                    dict.Remove(key);</span><br><span class="line">                    index++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>



<p>原版Lua虚拟机则是根据正整数Key是否落在当前数组可容纳范围内决定是否放入数组，并在hash部分满后进行rehash来对数组和hash表进行空间调整，最终目标是数组部分利用率超过50%</p>
<h3 id="优化建议-1"><a href="#优化建议-1" class="headerlink" title="优化建议"></a>优化建议</h3><p>长度小的table在新增元素时会触发多次rehash，在预先知道table元素数量时，应当进行预填充避免不必要的扩容与rehash操作</p>
<h2 id="Closure（闭包）与Upvalue"><a href="#Closure（闭包）与Upvalue" class="headerlink" title="Closure（闭包）与Upvalue"></a>Closure（闭包）与Upvalue</h2><p>闭包一般指的是使用了其外层函数局部变量的内部函数，而Upvalue则是这个被引用的局部变量</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">local</span> func1 = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> a = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> func2 = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">        a = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>上面的func2就是一个闭包，而变量a就是一个Upvalue</p>
<h3 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h3><p>闭包的定义如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 闭包</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Closure</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Closure</span>(<span class="params">FuncPrototype proto</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Proto = proto;</span><br><span class="line">        CSFunc = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Proto.UpvalueInfos.Length &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Upvalues = <span class="keyword">new</span> Upvalue[Proto.UpvalueInfos.Length];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Closure</span>(<span class="params">Func&lt;LuaState, <span class="built_in">int</span>, <span class="built_in">int</span>&gt; csFunc,<span class="built_in">int</span> upvalueNum = <span class="number">0</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Proto = <span class="literal">null</span>;</span><br><span class="line">        CSFunc = csFunc;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (upvalueNum &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Upvalues = <span class="keyword">new</span> Upvalue[upvalueNum];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Lua函数闭包</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> FuncPrototype Proto;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> C#函数闭包</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Func&lt;LuaState, <span class="built_in">int</span>,<span class="built_in">int</span>&gt; CSFunc;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 捕获到的Upvalue列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Upvalue[] Upvalues;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>可以看到闭包内部还被分为了两种：Lua函数闭包与C#函数闭包</p>
<p>因为在虚拟机实现上<strong>所有函数都是以闭包的形式存在的</strong>（即便是Chunk主函数也捕获到了名为”_Env”的Upvalue），所以如果要在Lua代码中调用C#层定义的函数，就需要将其封装为<strong>可供虚拟机调用的函数形式</strong>，然后以闭包的方式传入</p>
<p>如print函数：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">Print</span>(<span class="params">LuaState vm, <span class="built_in">int</span> argsNum</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="built_in">string</span> s = <span class="built_in">string</span>.Empty;</span><br><span class="line">           s += <span class="string">&quot;Lua Print:&quot;</span>;</span><br><span class="line">           LuaDataUnion[] datas = vm.PopN(argsNum);</span><br><span class="line">           <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; argsNum; i++)</span><br><span class="line">           &#123;</span><br><span class="line">               s += datas[i].ToString();</span><br><span class="line">               s += <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           Debug.Log(s);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>C#闭包其固定参数为<strong>LuaState对象和参数数量</strong>，返回值则为该函数的<strong>返回值数量</strong>，如print函数无返回值则其C#闭包返回0</p>
<h3 id="Upvalue"><a href="#Upvalue" class="headerlink" title="Upvalue"></a>Upvalue</h3><p>之所以会将被使用的局部变量称为Upvalue，是因为闭包会延长这个局部变量的生命周期，使其即便离开作用域仍然有可能存活</p>
<p>Upvalue的定义如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Upvalue</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Upvalue</span>(<span class="params">LuaDataUnion <span class="keyword">value</span>,<span class="built_in">bool</span> isOpen = <span class="literal">false</span>,<span class="built_in">int</span> globalStackIndex = <span class="number">0</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Value = <span class="keyword">value</span>;</span><br><span class="line">            IsOpen = isOpen;</span><br><span class="line">            GlobalStackIndex = globalStackIndex;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 是否为开放状态（引用到的Lua值是否在栈中）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> IsOpen;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> LuaDataUnion Value</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 引用到的Lua值在栈中的全局索引</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> GlobalStackIndex</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 修改引用到的Lua值</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetValue</span>(<span class="params">LuaDataUnion <span class="keyword">value</span>,LuaState vm</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            Value = <span class="keyword">value</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (IsOpen)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//upvalue处于开放状态 意味着引用的Lua值在栈中，需要一并更新栈</span></span><br><span class="line">                vm.Push(Value);</span><br><span class="line">                vm.PopAndCopy(GlobalStackIndex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>在Lua中Upvalue是被区分为<strong>开放状态</strong>与<strong>闭合状态</strong>的</p>
<ul>
<li>开放状态意味着此时此Upvalue所代表的局部变量仍然存活在栈中，修改Upvalue也需要修改栈中的局部变量</li>
<li>闭合状态意味着那个局部变量已经离开作用域了</li>
</ul>
<p>在原版Lua的实现中，若Upvalue处于开放状态则使用指针v来引用那个局部变量，这样可以做到对Upvalue的修改会同时影响到栈中局部变量。而一旦闭合了，就将局部变量复制到value中并让v指向value，这样局部变量就成为了此Upvalue所独有</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">UpVal</span> &#123;</span></span><br><span class="line">	CommonHeader;</span><br><span class="line">	TValue *v; <span class="comment">/* points to stack or to its own value */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		TValue value; <span class="comment">/* the value (when closed) */</span></span><br><span class="line">		<span class="comment">//省略...</span></span><br><span class="line">	&#125; u;</span><br><span class="line">&#125; UpVal;</span><br></pre></td></tr></table></figure>



<p>由于C#通常情况下没有指针，所以只能记录开放状态下的局部变量的栈中索引，然后在被修改时一并对栈中数据进行修改</p>
<h1 id="Lua虚拟栈"><a href="#Lua虚拟栈" class="headerlink" title="Lua虚拟栈"></a>Lua虚拟栈</h1><p>有了对Lua数据类型的定义就可以着手于Lua虚拟栈了</p>
<p>其定义如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Lua虚拟栈</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LuaStack</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LuaStack</span> (<span class="params"><span class="built_in">int</span> size</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            stack = <span class="keyword">new</span> LuaDataUnion[size];</span><br><span class="line">            Top = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 存放Lua数据的可索引的栈</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> LuaDataUnion[] stack;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 栈顶索引</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Top;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//省略...</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 往栈顶压入值</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Push</span>(<span class="params">LuaDataUnion data</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//省略...</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 从栈顶弹出值</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> LuaDataUnion <span class="title">Pop</span>(<span class="params"></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//省略...</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据索引从栈中获取值</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> LuaDataUnion <span class="title">Get</span>(<span class="params"><span class="built_in">int</span> index</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//省略...</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据索引在栈中设置值</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Set</span>(<span class="params"><span class="built_in">int</span> index, LuaDataUnion <span class="keyword">value</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//省略...</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">//省略...</span></span><br><span class="line">     </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Lua虚拟栈的本质就是使用LuaDataUnion数组来模拟栈，并记录栈顶位置，然后封装了对栈的基本操作</p>
<h1 id="LuaState"><a href="#LuaState" class="headerlink" title="LuaState"></a>LuaState</h1><p>LuaState可理解为Lua虚拟机对象，其主要持有一个LuaStack作为全局虚拟栈，以及一个LuaTable作为全局注册表，定义如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> Lua解释器核心</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">LuaState</span></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="title">LuaState</span>(<span class="params"><span class="built_in">int</span> size</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">          globalStack = <span class="keyword">new</span> LuaStack(size);</span><br><span class="line"></span><br><span class="line">          <span class="comment">//将全局环境表放入注册表</span></span><br><span class="line">          registry[Constants.GlobalEnvKey] = Factory.NewTable(<span class="keyword">new</span> LuaTable());</span><br><span class="line"></span><br><span class="line">          <span class="comment">//省略...</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 全局Lua虚拟栈</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">private</span> LuaStack globalStack;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 全局Lua注册表</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">private</span> LuaTable registry = <span class="keyword">new</span> LuaTable();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//省略...</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 加载Lua字节码</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">LoadChunk</span>(<span class="params"><span class="built_in">byte</span>[] bytes, <span class="built_in">string</span> chunkName</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">          Chunk chunk = Chunk.Undump(bytes);</span><br><span class="line">          LoadMainFunc(chunk.MainFunc);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 加载主函数原型,将其实例化为闭包，压入栈顶</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">LoadMainFunc</span>(<span class="params">FuncPrototype mainFunc</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">          Closure c = <span class="keyword">new</span> Closure(mainFunc);</span><br><span class="line">          Push(c);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (c.Proto.UpvalueInfos.Length &gt; <span class="number">0</span>)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="comment">//设置全局环境表到入口函数的upvalue中</span></span><br><span class="line">              LuaDataUnion g = registry[Constants.GlobalEnvKey];</span><br><span class="line">              c.Upvalues[<span class="number">0</span>] = <span class="keyword">new</span> Upvalue(g);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//省略...</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<p>此外还封装了大量的对LuaStack的操作，如调用函数，设置元表，开启标准库等</p>
<p><img src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/CatLuaDevSummary/CatLuaDevSummary_2.png"></p>
<h1 id="函数调用"><a href="#函数调用" class="headerlink" title="函数调用"></a>函数调用</h1><p>函数调用部分可谓是整个CatLua中相当麻烦的一部分，笔者在反复测试重构后，采取了基于栈帧的函数调用流程</p>
<p>所谓栈帧，指的是<strong>对栈的一部分切片的抽象</strong>，每次函数调用都会产生一个栈帧来处理此函数中对栈数据的操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">local func1 = function()</span><br><span class="line">    func2()</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">local func2 = function()</span><br><span class="line">    func3()</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">local func3 = function()</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">func1()  </span><br></pre></td></tr></table></figure>

<p><img src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/CatLuaDevSummary/CatLuaDevSummary_3.png"></p>
<p>同时，在调用函数时还会区分主调栈帧和被调栈帧，比如在func1中调用func2时，func1的栈帧就是主调栈帧，func2的栈帧就是被调栈帧</p>
<p>栈帧的定义如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> 函数调用栈帧</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FuncCallFrame</span></span><br><span class="line">   &#123;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">FuncCallFrame</span>(<span class="params">Closure closure = <span class="literal">null</span>, <span class="built_in">int</span> bottom = <span class="number">0</span></span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           Closure = closure;</span><br><span class="line">           Bottom = bottom;</span><br><span class="line"></span><br><span class="line">           <span class="built_in">int</span> size = <span class="number">0</span>;</span><br><span class="line">           <span class="keyword">if</span> (Closure != <span class="literal">null</span> &amp;&amp; Closure.Proto != <span class="literal">null</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               size = Closure.Proto.MaxStackSize;</span><br><span class="line">           &#125;</span><br><span class="line">           ReserveRegisterMaxIndex = (Bottom - <span class="number">1</span>) + size; </span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 变长参数</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> LuaDataUnion[] VarArgs;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 指令索引</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">int</span> PC;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 前一个函数的调用栈帧</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> FuncCallFrame Prev;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 闭包</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> Closure Closure</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">get</span>;</span><br><span class="line">           <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 栈帧的预留寄存器区域最大索引</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">int</span> ReserveRegisterMaxIndex</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">get</span>;</span><br><span class="line">           <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 栈帧的栈底索引</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">int</span> Bottom</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">get</span>;</span><br><span class="line">           <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<p>因为一个LuaState只有一个全局的LuaStack，因为每个栈帧就需要记录下当前栈帧的栈底，方便弹出栈帧时正确恢复栈顶，同时还要记录下前一个函数调用栈帧，方便进行恢复操作</p>
<p>此外还需要注意的是ReserveRegisterMaxIndex这个值，每个栈帧都有N个为寄存器预留的位置，因此<strong>在压入新栈帧时就不能占用这些预留的位置</strong></p>
<p><img src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/CatLuaDevSummary/CatLuaDevSummary_4.png"></p>
<p>同时可能该栈帧因为操作的数据过多导致栈顶范围溢出了ReserveRegisterMaxIndex，所以<strong>在压入新栈帧时也不能占用这些溢出的位置</strong></p>
<p>在考虑上面两个限制后，就需要通过<code>Max(ReserveRegisterMaxIndex + 1,Top +1)</code>来计算出新栈帧的栈底位置，然后调整栈顶到新栈帧的栈底（保证后续压入的函数参数从新栈帧的Bottom开始）</p>
<p>以Lua函数调用为例（C#函数调用流程则是Lua函数调用流程的简化版本），在CatLua中将整个调用流程分为了3个阶段：</p>
<ol>
<li><strong>调用Lua函数前</strong></li>
<li><strong>执行Lua函数调用</strong></li>
<li><strong>Lua函数调用后</strong></li>
</ol>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PreLuaFuncCall(argsNum);</span><br><span class="line">ExcuteLuaFuncCall();</span><br><span class="line">PostLuaFuncCall(resultNum);</span><br></pre></td></tr></table></figure>

<p>其中argsNum为调用函数的参数数量，resultNum为返回值数量</p>
<p>接下来会以下述代码中func1调用func2的流程来进行讲解</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">func1</span><span class="params">()</span></span>&#123;</span><br><span class="line">    func2(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">func2</span><span class="params">(num)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func1()</span><br></pre></td></tr></table></figure>





<h2 id="PreLuaFuncCall"><a href="#PreLuaFuncCall" class="headerlink" title="PreLuaFuncCall"></a>PreLuaFuncCall</h2><p>在PreLuaFuncCall前，会先将要调用的函数和参数从指定位置复制并压入到主调栈帧的栈顶，并根据Call指令的指令参数和栈顶位置计算出函数参数的数量（如果有变长参数，那么实际参数数量也是在此时被计算出）</p>
<p><img src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/CatLuaDevSummary/CatLuaDevSummary_5.png"></p>
<p>进入PreLuaFuncCal后，要从主调栈帧的栈顶弹出函数与参数，并为被调函数创建新栈帧，压入新栈帧和参数</p>
<p><img src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/CatLuaDevSummary/CatLuaDevSummary_6.png"></p>
<p>接下来再次修改Top，将其指向ReserveRegisterMaxIndex后的位置，<strong>保证后续压入新值不会占用预留的寄存器</strong></p>
<p><img src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/CatLuaDevSummary/CatLuaDevSummary_7.png"></p>
<p>接下来如果还有变长参数，就会将变长参数收集到栈帧中</p>
<p>PreLuaFuncCall完整代码如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 为Lua函数调用作准备，将被调函数和参数压入新栈帧内</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">PreLuaFuncCall</span>(<span class="params"><span class="built_in">int</span> argsNum</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//从主调栈帧的栈顶弹出函数与参数</span></span><br><span class="line">    LuaDataUnion[] FuncAndParams = globalStack.PopN(argsNum + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    Closure c = FuncAndParams[<span class="number">0</span>].Closure;</span><br><span class="line">   </span><br><span class="line">    <span class="built_in">int</span> paramsNum = c.Proto.NumParams;</span><br><span class="line">    <span class="built_in">bool</span> isVarArg = c.Proto.IsVararg != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//为被调函数创建栈帧</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置被调栈帧的栈底 需要保证在之前的栈帧之上 不会和之前的栈帧数据重叠</span></span><br><span class="line">    <span class="comment">//如果之前的栈帧里保存的数据没超过预留寄存器数量，就设为curFrame.ReserveRegisterMaxIndex + 1，否则设为Top + 1</span></span><br><span class="line">    <span class="built_in">int</span> bottom = Math.Max(curFrame.ReserveRegisterMaxIndex + <span class="number">1</span>, Top + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    FuncCallFrame newFrame = <span class="keyword">new</span> FuncCallFrame(c,bottom);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//压入被调栈帧 并修改栈顶</span></span><br><span class="line">    PushFuncCallFrameAndSetTop(newFrame);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将固定参数压入被调栈帧</span></span><br><span class="line">    globalStack.PushN(FuncAndParams, <span class="number">1</span>, paramsNum);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//再次修改栈顶 指向最后一个预留寄存器</span></span><br><span class="line">    <span class="comment">//这样后续push任意新值都不会占用到栈帧自己预留的寄存器位置</span></span><br><span class="line">    SetTop(newFrame.ReserveRegisterMaxIndex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argsNum &gt; paramsNum &amp;&amp; isVarArg)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//实际参数多于固定参数 并且这个函数有变长参数</span></span><br><span class="line">        <span class="comment">//就把多出来的参数收集到变长参数里处理</span></span><br><span class="line">        LuaDataUnion[] varArgs = <span class="keyword">new</span> LuaDataUnion[argsNum - paramsNum];</span><br><span class="line">        Array.Copy(FuncAndParams, paramsNum + <span class="number">1</span>, varArgs, <span class="number">0</span>, varArgs.Length);</span><br><span class="line">        newFrame.VarArgs = varArgs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="ExcuteLuaFuncCall"><a href="#ExcuteLuaFuncCall" class="headerlink" title="ExcuteLuaFuncCall"></a>ExcuteLuaFuncCall</h2><p>执行函数调用部分处理，就是通过一个while true循环不断取出指令执行，然后在碰到Return指令的时候结束循环就可以了</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 执行Lua函数调用</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ExcuteLuaFuncCall</span>(<span class="params"></span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="comment">//不断取出指令执行 直到遇到return指令</span></span><br><span class="line">              Instructoin i = <span class="keyword">new</span> Instructoin(Fetch());</span><br><span class="line">              i.Execute(<span class="keyword">this</span>);</span><br><span class="line">              <span class="keyword">if</span> (i.OpType == OpCodeType.Return)</span><br><span class="line">              &#123;</span><br><span class="line">                 <span class="comment">//此时已经将返回值准备在栈顶上了</span></span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>



<p>需要注意的是，在处理Return指令的时候，会将返回值都压入栈顶，并记录返回值数量（如果有变长返回值，那么实际返回值数量也是在此时被计算出并记录）</p>
<p><img src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/CatLuaDevSummary/CatLuaDevSummary_8.png"></p>
<h2 id="PostLuaFuncCall"><a href="#PostLuaFuncCall" class="headerlink" title="PostLuaFuncCall"></a>PostLuaFuncCall</h2><p>函数调用结束后，所有返回值都被Return指令放到了栈顶，那么接下来就需要取出返回值，恢复栈顶到Buttom-1，弹出被调栈帧，闭合Upvalue</p>
<p><img src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/CatLuaDevSummary/CatLuaDevSummary_9.png"></p>
<p>最后将resultNum个返回值压入到主调栈帧上，不足的部分用nil补齐即可</p>
<p><img src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/CatLuaDevSummary/CatLuaDevSummary_10.png"></p>
<p>如此便完成了整个函数调用流程</p>
<p>PostLuaFuncCall完整代码如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Lua函数调用完成后，将被调函数栈帧的栈顶返回值压入主调函数栈帧的栈顶</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">PostLuaFuncCall</span>(<span class="params"><span class="built_in">int</span> resultNum</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (resultNum == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//没返回值 直接弹出被调栈帧 并闭合upvalue以及恢复栈顶</span></span><br><span class="line">        PopFuncCallFrameAndSetTop();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//取出所有返回值</span></span><br><span class="line">    LuaDataUnion[] results = globalStack.PopN(CallFrameReturnResultNum);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//弹出被调栈帧 并闭合upvalue以及恢复栈顶</span></span><br><span class="line">    PopFuncCallFrameAndSetTop();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//压入resultNum个返回值到主调栈帧上，不足的部分用nil补</span></span><br><span class="line">    <span class="comment">//resultNum为-1时就全部压入</span></span><br><span class="line">    globalStack.PushN(results, <span class="number">0</span>, resultNum);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="PCall"><a href="#PCall" class="headerlink" title="PCall"></a>PCall</h1><p>Lua中的PCall相当于其他语言中的try catch的作用，能够在调用一个函数报错后中断调用流程并将异常信息返回</p>
<p>因此可以直接在C#中使用try catch来实现PCall，并且有了栈帧的概念下，只要在调用前记录下当前栈帧，如果进入了catch块就不断弹出栈帧，直到回到了初始的调用栈帧，最后将异常信息压入栈顶即可</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> FuncCallState <span class="title">PCall</span>(<span class="params"><span class="built_in">int</span> argsNum,<span class="built_in">int</span> resultsNum,<span class="built_in">int</span> msg</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            FuncCallFrame frame = curFrame;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                CallFunc(argsNum, resultsNum);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Exception e)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//不断弹出栈帧 直到到了初始的调用栈帧</span></span><br><span class="line">                <span class="keyword">while</span> (curFrame != frame)</span><br><span class="line">                &#123;</span><br><span class="line">                    PopFuncCallFrameAndSetTop();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//将异常信息作为pcall的返回值压入调用栈帧的栈顶</span></span><br><span class="line">                CallFrameReturnResultNum = <span class="number">1</span>;</span><br><span class="line">                Push(e.Message);</span><br><span class="line">                <span class="keyword">return</span> FuncCallState.ErrRun;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> FuncCallState.Ok;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>



<h1 id="GC算法"><a href="#GC算法" class="headerlink" title="GC算法"></a>GC算法</h1><p>因为C#是自带GC的语言，所以并未给CatLua实现一套GC算法</p>
<p>不过在这里仍然简单阐述下原版Lua的GC算法</p>
<h2 id="双色标记"><a href="#双色标记" class="headerlink" title="双色标记"></a>双色标记</h2><p>Lua和C#一样，采用的是引用追踪式GC，每次GC时会从根对象出发（全局变量，栈，寄存器）遍历所有对象，被标记的就是可达对象，否则是不可达的，不可达对象被视为内存垃圾</p>
<p>5.0前采用<strong>双色标记</strong>，每个对象非黑即白（扫描过的是黑色，未扫描过的是白色）</p>
<p>双色标记GC算法过程：</p>
<ol>
<li>初始化阶段：遍历root引用的对象，将其加入对象链表</li>
<li>标记阶段：从对象链表中取出未扫描元素，将其标记为黑色，并遍历该元素关联的所有对象，也标记为黑色</li>
<li>回收阶段：遍历所有对象，如果是白色就回收，如果是黑色不回收</li>
</ol>
<p>这种方法要求<strong>一次性完成GC不能打断</strong>，会造成较长时间的卡顿</p>
<p><strong>为什么不能被打断？</strong></p>
<p>因为在标记阶段后创建的新对象在本轮GC中将无法继续被标记，这样就会导致可能会用到的新对象被GC清理掉了从而导致出Bug</p>
<h2 id="三色标记"><a href="#三色标记" class="headerlink" title="三色标记"></a>三色标记</h2><p>Lua5.1开始采用三色标记法，实现了增量的回收，3种颜色分别是：</p>
<p><strong>白色</strong>：待访问状态，对象未被GC访问过，如果在结束GC扫描后仍然是白色，就说明其是内存垃圾</p>
<p><strong>灰色</strong>：待扫描状态，对象未被GC访问过，但已经准备进行访问</p>
<p><strong>黑色</strong>：已扫描状态，对象已被GC访问过</p>
<p>三色标记GC算法过程：</p>
<ol>
<li>初始化阶段，遍历root引用的对象，从白色改为灰色，放入灰色节点链表（灰色节点链表相当于记录了当前GC的进度）</li>
<li>标记阶段：不断从灰色链表取出元素，标记为黑色，然后遍历其关联的所有对象，标记为灰色，加入灰色链表，此阶段可打断</li>
<li>原子标记阶段：不可打断的阶段，用于处理第二灰色链表的标记</li>
<li>回收阶段：灰色链表为空后，遍历所有对象，如果为白色就回收</li>
</ol>
<p>虽然多数对象是从白到灰，但是像string这种不可能引用其他对象的数据类型是直接从白到黑的</p>
<p>但即便是增量回收，在回收前依然有一个不可打断的<strong>原子标记阶段</strong>存在：</p>
<p>首先，因为标记阶段可以被打断，这样在期间可能会有新对象创建，并且被一个黑色对象引用了，但这是不允许的，因为黑色已经标记过了，本轮GC不会再扫描它，这样其引用的的白色对象也不会被标记，到了回收阶段就会被误回收</p>
<p>这时就需要两种不同的处理：</p>
<ol>
<li><strong>前向barrier</strong>：将新创建的对象直接设置为灰色，适用于引用新对象的黑色对象不会频繁改变引用关系的数据类型，如lua的proto</li>
<li><strong>后向barrier</strong>：将引用新对象的黑色对象设置为灰色，放入第二灰色链表，在原子标记阶段一次性进行标记，适用于黑色对象可能频繁改变引用关系的数据类型，如table。而如果直接把从黑色变灰色的table对象放入灰色链表，因为table的key和value引用关系变化频繁，就可能在黑色和灰色间反复横跳，进行很多重复的扫描，所以需要将table放入第二灰色链表中，在原子标记阶段一次性处理完</li>
</ol>
<h1 id="词法分析"><a href="#词法分析" class="headerlink" title="词法分析"></a>词法分析</h1><p>词法分析所做的即是不断地将源代码字符串中的<strong>词法单元</strong>(Token)给识别出来，形成一个Token流供语法分析进行提取</p>
<p>Lua中的Token主要分为以下几类：</p>
<ol>
<li><strong>分隔符</strong></li>
<li><strong>运算符</strong></li>
<li><strong>字符串字面量</strong></li>
<li><strong>数字字面量</strong></li>
<li><strong>标识符</strong></li>
<li><strong>关键字</strong></li>
</ol>
<p>CatLua中对词法分析的实现比较简单，通过对首字符的内容switch case加上正则表达式进行Token识别</p>
<p>例如：当前字符指向一个”=”，此字符可能构成了“=”，也可能构成了”==”，那么就判断剩余字符是否以”==”开头，若是，则返回token为”==”，否则返回”=”</p>
<p>具体代码如下：</p>
<p>首先定义TokenType枚举</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> Token类型</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">enum</span> TokenType</span><br><span class="line">  &#123;</span><br><span class="line">      Eof,  <span class="comment">//end-of-file</span></span><br><span class="line">      Vararg,  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">      SepSemi,  <span class="comment">//;</span></span><br><span class="line">      SepComma,  <span class="comment">//,</span></span><br><span class="line">      SepDot,  <span class="comment">//.</span></span><br><span class="line">      SepColon,  <span class="comment">//:</span></span><br><span class="line">      SepLable,  <span class="comment">//::</span></span><br><span class="line">      SepLparen,  <span class="comment">//(</span></span><br><span class="line">      SepRparen,  <span class="comment">//)</span></span><br><span class="line">      SepLbrack,  <span class="comment">//[</span></span><br><span class="line">      SepRbrack,  <span class="comment">//]</span></span><br><span class="line">      SepLcurly,  <span class="comment">//&#123;</span></span><br><span class="line">      SepRcurly,  <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      OpAsssign,  <span class="comment">//=</span></span><br><span class="line">      OpMinus,  <span class="comment">//-</span></span><br><span class="line">      OpWave,  <span class="comment">//~</span></span><br><span class="line">      OpAdd,  <span class="comment">//+</span></span><br><span class="line">      OpMul,  <span class="comment">//*</span></span><br><span class="line">      OpDiv,  <span class="comment">// /</span></span><br><span class="line">      OpIDiv,  <span class="comment">// //</span></span><br><span class="line">      OpPow,  <span class="comment">//^</span></span><br><span class="line">      OpMod,  <span class="comment">//%</span></span><br><span class="line">      OpBAnd,  <span class="comment">//&amp;</span></span><br><span class="line">      OpBOr,  <span class="comment">//|</span></span><br><span class="line">      OpShR,  <span class="comment">//&gt;&gt;</span></span><br><span class="line">      OpShL,  <span class="comment">//&lt;&lt;</span></span><br><span class="line">      OpConcat,  <span class="comment">//..</span></span><br><span class="line">      OpLt,  <span class="comment">//&lt;</span></span><br><span class="line">      OpLe,  <span class="comment">//&lt;=</span></span><br><span class="line">      OpGt,  <span class="comment">//&gt;</span></span><br><span class="line">      OpGe,  <span class="comment">//&gt;=</span></span><br><span class="line">      OpEq,  <span class="comment">//==</span></span><br><span class="line">      OpNe,  <span class="comment">//~=</span></span><br><span class="line">      OpLen,  <span class="comment">//#</span></span><br><span class="line">      OpAnd,  <span class="comment">//and</span></span><br><span class="line">      OpOr,  <span class="comment">//or</span></span><br><span class="line">      OpNot,  <span class="comment">//not</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      KwBreak,  <span class="comment">//break</span></span><br><span class="line">      KwDo,  <span class="comment">//do</span></span><br><span class="line">      KwElse,  <span class="comment">//else</span></span><br><span class="line">      KwElseif,  <span class="comment">//elseif</span></span><br><span class="line">      KwEnd,  <span class="comment">//end</span></span><br><span class="line">      KwFalse,  <span class="comment">//false</span></span><br><span class="line">      KwFor,  <span class="comment">//for</span></span><br><span class="line">      KwFunction,  <span class="comment">//function</span></span><br><span class="line">      KwGoto,  <span class="comment">//goto</span></span><br><span class="line">      KwIf,  <span class="comment">//if</span></span><br><span class="line">      KwIn,  <span class="comment">//in</span></span><br><span class="line">      KwLocal,  <span class="comment">//local</span></span><br><span class="line">      KwNil,  <span class="comment">//nil</span></span><br><span class="line">      KwRepeat,  <span class="comment">//repeat</span></span><br><span class="line">      KwReturn,  <span class="comment">//return</span></span><br><span class="line">      KwThen,  <span class="comment">//then</span></span><br><span class="line">      KwTrue,  <span class="comment">//true</span></span><br><span class="line">      KwUntil,  <span class="comment">//until</span></span><br><span class="line">      KwWhile,  <span class="comment">//while</span></span><br><span class="line"></span><br><span class="line">      Identifier,  <span class="comment">//identifier</span></span><br><span class="line">      Number,  <span class="comment">//number literal</span></span><br><span class="line">      String,   <span class="comment">//string literal</span></span><br><span class="line"></span><br><span class="line">      OpUnm = OpMinus,</span><br><span class="line">      OpSub = OpMinus,</span><br><span class="line">      OpBNot = OpWave,</span><br><span class="line">      OpBXor = OpWave,</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<p>然后定义词法分析器Lexer</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> 词法分析器</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Lexer</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">Lexer</span>(<span class="params"><span class="built_in">string</span> chunk, <span class="built_in">string</span> chunkName</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">this</span>.chunk = chunk;</span><br><span class="line">           <span class="keyword">this</span>.chunkName = chunkName;</span><br><span class="line">           Line = <span class="number">1</span>;</span><br><span class="line">           curIndex = <span class="number">0</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">      	<span class="comment">//省略...</span></span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 匹配十进制整数或浮点数的正则表达式</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">static</span> Regex numberRegex = <span class="keyword">new</span> Regex(<span class="string">@&quot;^-?\d+$|^(-?\d+)(\.\d+)?&quot;</span>, RegexOptions.Compiled);</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 匹配标识符和关键字的正则表达式</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">static</span> Regex identifierRegex = <span class="keyword">new</span> Regex(<span class="string">@&quot;^[_\d\w]+&quot;</span>, RegexOptions.Compiled);</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 匹配短字符串的正则表达式（不支持转义字符</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">static</span> Regex shortStrRegex = <span class="keyword">new</span> Regex(<span class="string">&quot;^\&quot;[^\&quot;]*\&quot;&quot;</span>, RegexOptions.Compiled);</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 源代码</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">private</span> <span class="built_in">string</span> chunk;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 源文件名</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">private</span> <span class="built_in">string</span> chunkName;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 当前索引</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">private</span> <span class="built_in">int</span> curIndex;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//省略...</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 返回下一个token，对应行号和token类型，并将其跳过</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetNextToken</span>(<span class="params"><span class="keyword">out</span> <span class="built_in">int</span> line, <span class="keyword">out</span> <span class="built_in">string</span> token, <span class="keyword">out</span> TokenType type</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="comment">//省略...</span></span><br><span class="line">           </span><br><span class="line">           <span class="comment">//跳过空白字符，回车，换行与注释</span></span><br><span class="line">           SkipWhiteSpaces();</span><br><span class="line"></span><br><span class="line">           line = Line;</span><br><span class="line"></span><br><span class="line">           token = <span class="literal">default</span>;</span><br><span class="line">           type = <span class="literal">default</span>;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (curIndex &gt;= chunk.Length)</span><br><span class="line">           &#123;</span><br><span class="line">               type = TokenType.Eof;</span><br><span class="line">               token = <span class="string">&quot;Eof&quot;</span>;</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="built_in">char</span> c = chunk[curIndex];</span><br><span class="line"></span><br><span class="line">           <span class="comment">//分隔符,运算符和字符串</span></span><br><span class="line">           <span class="keyword">switch</span> (c)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">case</span> <span class="string">&#x27;;&#x27;</span>:</span><br><span class="line">                   Next(<span class="number">1</span>);</span><br><span class="line">                   type = TokenType.SepSemi;</span><br><span class="line">                   token = <span class="string">&quot;;&quot;</span>;</span><br><span class="line">                   <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">case</span> <span class="string">&#x27;,&#x27;</span>:</span><br><span class="line">                   Next(<span class="number">1</span>);</span><br><span class="line">                   type = TokenType.SepComma;</span><br><span class="line">                   token = <span class="string">&quot;,&quot;</span>;</span><br><span class="line">                   <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">case</span> <span class="string">&#x27;(&#x27;</span>:</span><br><span class="line">                   Next(<span class="number">1</span>);</span><br><span class="line">                   type = TokenType.SepLparen;</span><br><span class="line">                   token = <span class="string">&quot;(&quot;</span>;</span><br><span class="line">                   <span class="keyword">return</span>;</span><br><span class="line">                   </span><br><span class="line">               <span class="keyword">case</span> <span class="string">&#x27;)&#x27;</span>:</span><br><span class="line">                   Next(<span class="number">1</span>);</span><br><span class="line">                   type = TokenType.SepRparen;</span><br><span class="line">                   token = <span class="string">&quot;)&quot;</span>;</span><br><span class="line">                   <span class="keyword">return</span>;</span><br><span class="line">                   </span><br><span class="line">               <span class="keyword">case</span> <span class="string">&#x27;=&#x27;</span>:</span><br><span class="line">                   <span class="keyword">if</span> (Test(<span class="string">&quot;==&quot;</span>))</span><br><span class="line">                   &#123;</span><br><span class="line">                       Next(<span class="number">2</span>);</span><br><span class="line">                       type = TokenType.OpEq;</span><br><span class="line">                       token = <span class="string">&quot;==&quot;</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">else</span></span><br><span class="line">                   &#123;</span><br><span class="line">                       Next(<span class="number">1</span>);</span><br><span class="line">                       type = TokenType.OpAsssign;</span><br><span class="line">                       token = <span class="string">&quot;=&quot;</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">return</span>;</span><br><span class="line">				<span class="comment">//省略...</span></span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">//数字字面量</span></span><br><span class="line">           <span class="keyword">if</span> (c == <span class="string">&#x27;.&#x27;</span> || <span class="built_in">char</span>.IsDigit(c))</span><br><span class="line">           &#123;</span><br><span class="line">               token = ScanNumber();</span><br><span class="line">               type = TokenType.Number;</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">//标识符或关键字</span></span><br><span class="line">           <span class="keyword">if</span> (c == <span class="string">&#x27;_&#x27;</span> || <span class="built_in">char</span>.IsLetter(c))</span><br><span class="line">           &#123;</span><br><span class="line">               token = ScanIdentifier();</span><br><span class="line">               <span class="keyword">if</span> (KeyWordTokenMap.TryGetValue(token,<span class="keyword">out</span> type))</span><br><span class="line">               &#123;</span><br><span class="line">                   <span class="comment">//关键字</span></span><br><span class="line">                   <span class="keyword">return</span>;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="comment">//标识符</span></span><br><span class="line">               type = TokenType.Identifier;</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           Error(<span class="string">&quot;语法错误，当前字符为:&quot;</span> + c);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 跳过n个字符</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Next</span>(<span class="params"><span class="built_in">int</span> n</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           curIndex += n;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 剩余的源代码是否以s开头</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">Test</span>(<span class="params"><span class="built_in">string</span> s</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">return</span> chunk.Substring(curIndex).StartsWith(s);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">      </span><br><span class="line">	<span class="comment">//省略...</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<p>这样就完成了词法分析的过程</p>
<h1 id="语法分析"><a href="#语法分析" class="headerlink" title="语法分析"></a>语法分析</h1><p>语法分析的作用即是根据编程语言的文法规则，将token序列转换为抽象语法树（AST）</p>
<p>如<code>a * ( b + c )</code>的AST如下：</p>
<p><img src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/CatLuaDevSummary/CatLuaDevSummary_11.png"></p>
<p>Lua的文法规则采用了一种上下文无关文法EBNF（扩展的巴科斯范式）</p>
<p>该文法定义了编程语言中每种合法语句/表达式由一些什么东西构成</p>
<p>语句和表达式的区别主要在于：<strong>语句可执行，表达式可求值</strong>（因此函数即是表达式也是语句）</p>
<p>同时Lua采用的是<strong>递归下降</strong>法进行语法分析，遇到关键字就检查是否匹配，遇到语句/表达式就调用相应的解析方法进行解析</p>
<h2 id="一个示例：解析do语句"><a href="#一个示例：解析do语句" class="headerlink" title="一个示例：解析do语句"></a>一个示例：解析do语句</h2><p>do语句在Lua中表现为：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="comment">--do something</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>do语句的EBNF文法定义为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dostat -&gt; DO block END</span><br></pre></td></tr></table></figure>

<p>该定义表达了Lua中的do语句由1个关键字do，1个代码块block，最后再来1个关键字End构成</p>
<p>而在进行具体的do语句解析中，逻辑就是这样的：</p>
<ol>
<li><strong>提取并丢弃do关键字</strong></li>
<li><strong>ParseBlock解析1个block对象</strong></li>
<li><strong>提取并丢弃end关键字</strong></li>
<li><strong>用block对象创建Dostat对象中并返回</strong></li>
</ol>
<p>解析do语句的代码如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 解析do语句</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span>&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> DoStat <span class="title">ParseDoStat</span>(<span class="params">Lexer lexer</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//跳过do</span></span><br><span class="line">    lexer.GetNextTokenOfType(TokenType.KwDo, <span class="keyword">out</span> _, <span class="keyword">out</span> _);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析block</span></span><br><span class="line">    Block block = ParseBlock(lexer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//跳过end</span></span><br><span class="line">    lexer.GetNextTokenOfType(TokenType.KwEnd, <span class="keyword">out</span> _, <span class="keyword">out</span> _);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DoStat(block);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="函数原型编译"><a href="#函数原型编译" class="headerlink" title="函数原型编译"></a>函数原型编译</h1><p>在得到了AST后，就需要根据这个AST生成函数原型</p>
<p>编译过程和语法分析过程类似，也是采取一种<strong>递归下降</strong>的方法，根据遇到的语句/表达式调用不同的编译方法生成对应的指令</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 编译语句</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CompileStat</span>(<span class="params">GenFuncInfo fi, BaseStat stat</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="comment">//根据语句类型调用不同的编译方法</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (stat <span class="keyword">is</span> FuncCallStat)</span><br><span class="line">          &#123;</span><br><span class="line">              CompileFuncCallStat(fi, (FuncCallStat)stat);</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (stat <span class="keyword">is</span> BreakStat)</span><br><span class="line">          &#123;</span><br><span class="line">              CompileBreakStat(fi, (BreakStat)stat);</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (stat <span class="keyword">is</span> DoStat)</span><br><span class="line">          &#123;</span><br><span class="line">              CompileDoStat(fi, (DoStat)stat);</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">//省略...</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;不支持编译的语句：&quot;</span> + stat.GetType());</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">     <span class="comment"><span class="doctag">///</span> 编译表达式 </span></span><br><span class="line">     <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">     <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CompileExp</span>(<span class="params">GenFuncInfo fi, BaseExp exp, <span class="built_in">int</span> reg, <span class="built_in">int</span> num</span>)</span></span><br><span class="line">     &#123;</span><br><span class="line">         <span class="keyword">if</span> (exp <span class="keyword">is</span> NilExp)</span><br><span class="line">         &#123;</span><br><span class="line">             <span class="built_in">int</span> b = reg + num - <span class="number">1</span>;</span><br><span class="line">             fi.EmitLoadNil(reg, b);</span><br><span class="line">             <span class="keyword">return</span>;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (exp <span class="keyword">is</span> FalseExp)</span><br><span class="line">         &#123;</span><br><span class="line">             fi.EmitLoadBool(reg, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">             <span class="keyword">return</span>;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (exp <span class="keyword">is</span> TrueExp)</span><br><span class="line">         &#123;</span><br><span class="line">             fi.EmitLoadBool(reg, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">             <span class="keyword">return</span>;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">//省略...</span></span><br><span class="line"></span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;不支持编译的表达式：&quot;</span> + exp.GetType());</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>当然这里只是简要的展示了一下编译流程，实际过程中是有非常多的细节要处理的，包括但不限于：</p>
<ol>
<li><strong>计算寄存器位置</strong></li>
<li><strong>作用域层级管理</strong></li>
<li><strong>处理变长参数</strong></li>
<li><strong>处理变长返回值</strong></li>
<li><strong>处理Upvalue</strong></li>
<li><strong>处理跳转类指令的参数回填</strong></li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>CatLua开发总结</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="http://www.cathole.top/2021/11/09/catlua-dev-summary/">http://www.cathole.top/2021/11/09/catlua-dev-summary/</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a" style="display: inline-block;width: 120px"><h>作者</h><div class="post-copyright-cc-info"><h>自然妙有猫仙人</h></div></div><div class="post-copyright-c" style="display: inline-block;width: 120px"><h>发布于</h><div class="post-copyright-cc-info"><h>2021-11-09</h></div></div><div class="post-copyright-u" style="display: inline-block;width: 120px"><h>更新于</h><div class="post-copyright-cc-info"><h>2023-06-14</h></div></div><div class="post-copyright-c" style="display: inline-block;width: 120px"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY 4.0" href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC BY 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/">编译原理</a><a class="post-meta__tags" href="/tags/Lua/">Lua</a></div><div class="post_share"><div class="social-share" data-image="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/CatLuaDevSummary/CatLuaDevSummary_1.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/11/12/Interview-record/"><img class="prev-cover" src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/top_image.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">面试记录</div></div></a></div><div class="next-post pull-right"><a href="/2021/11/02/ui-optimization-of-mmo/"><img class="next-cover" src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/UIOptimizatioOfMMO/UIOptimizatioOfMMO_4.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">手游MMO项目的UI优化实践</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/12/05/catjson-dev-summary/" title="CatJson开发总结"><img class="cover" src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/CatJsonDevSummary/CatJsonDevSummary_1.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-05</div><div class="title">CatJson开发总结</div></div></a></div><div><a href="/2022/08/17/catjson-v2-dev-summary/" title="CatJsonV2开发总结"><img class="cover" src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/CatJsonV2DevSummary/CatJsonV2DevSummary_1.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-17</div><div class="title">CatJsonV2开发总结</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/head2.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">自然妙有猫仙人</div><div class="author-info__description">一个爱摸鱼的游戏程序员</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">24</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">9</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/CatImmortal" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:1304085906@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="tencent://message/?uin=1304085906&amp;Site=Sambow&amp;Menu=yes" target="_blank" title="QQ"><i class="fab fa-qq"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">QQ交流群：762036315</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lua%E5%AD%97%E8%8A%82%E7%A0%81%E8%AF%BB%E5%8F%96"><span class="toc-number">2.</span> <span class="toc-text">Lua字节码读取</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Chunk"><span class="toc-number">2.1.</span> <span class="toc-text">Chunk</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%BD%E6%95%B0"><span class="toc-number">2.2.</span> <span class="toc-text">函数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8C%87%E4%BB%A4"><span class="toc-number">3.</span> <span class="toc-text">指令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE"><span class="toc-number">3.0.1.</span> <span class="toc-text">优化建议</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lua%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">4.</span> <span class="toc-text">Lua数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Table"><span class="toc-number">4.1.</span> <span class="toc-text">Table</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%83%E8%A1%A8%E4%B8%8E%E5%85%83%E6%96%B9%E6%B3%95"><span class="toc-number">4.1.1.</span> <span class="toc-text">元表与元方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.1.2.</span> <span class="toc-text">面向对象的实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%92%E5%85%A5%E4%B8%8E%E6%89%A9%E5%AE%B9"><span class="toc-number">4.1.3.</span> <span class="toc-text">插入与扩容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE-1"><span class="toc-number">4.1.4.</span> <span class="toc-text">优化建议</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Closure%EF%BC%88%E9%97%AD%E5%8C%85%EF%BC%89%E4%B8%8EUpvalue"><span class="toc-number">4.2.</span> <span class="toc-text">Closure（闭包）与Upvalue</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AD%E5%8C%85"><span class="toc-number">4.2.1.</span> <span class="toc-text">闭包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Upvalue"><span class="toc-number">4.2.2.</span> <span class="toc-text">Upvalue</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lua%E8%99%9A%E6%8B%9F%E6%A0%88"><span class="toc-number">5.</span> <span class="toc-text">Lua虚拟栈</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#LuaState"><span class="toc-number">6.</span> <span class="toc-text">LuaState</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8"><span class="toc-number">7.</span> <span class="toc-text">函数调用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PreLuaFuncCall"><span class="toc-number">7.1.</span> <span class="toc-text">PreLuaFuncCall</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ExcuteLuaFuncCall"><span class="toc-number">7.2.</span> <span class="toc-text">ExcuteLuaFuncCall</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PostLuaFuncCall"><span class="toc-number">7.3.</span> <span class="toc-text">PostLuaFuncCall</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PCall"><span class="toc-number">8.</span> <span class="toc-text">PCall</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#GC%E7%AE%97%E6%B3%95"><span class="toc-number">9.</span> <span class="toc-text">GC算法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8C%E8%89%B2%E6%A0%87%E8%AE%B0"><span class="toc-number">9.1.</span> <span class="toc-text">双色标记</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E8%89%B2%E6%A0%87%E8%AE%B0"><span class="toc-number">9.2.</span> <span class="toc-text">三色标记</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%8D%E6%B3%95%E5%88%86%E6%9E%90"><span class="toc-number">10.</span> <span class="toc-text">词法分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95%E5%88%86%E6%9E%90"><span class="toc-number">11.</span> <span class="toc-text">语法分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E7%A4%BA%E4%BE%8B%EF%BC%9A%E8%A7%A3%E6%9E%90do%E8%AF%AD%E5%8F%A5"><span class="toc-number">11.1.</span> <span class="toc-text">一个示例：解析do语句</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E5%8E%9F%E5%9E%8B%E7%BC%96%E8%AF%91"><span class="toc-number">12.</span> <span class="toc-text">函数原型编译</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/04/20/assetbundle-build-patch/" title="在Unity中构建AssetBundle补丁包"><img src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/top_image.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="在Unity中构建AssetBundle补丁包"/></a><div class="content"><a class="title" href="/2023/04/20/assetbundle-build-patch/" title="在Unity中构建AssetBundle补丁包">在Unity中构建AssetBundle补丁包</a><time datetime="2023-04-20T13:04:54.000Z" title="发表于 2023-04-20 21:04:54">2023-04-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/12/31/2022-year-end-summary/" title="2022年终总结"><img src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/top_image.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2022年终总结"/></a><div class="content"><a class="title" href="/2022/12/31/2022-year-end-summary/" title="2022年终总结">2022年终总结</a><time datetime="2022-12-31T08:58:24.000Z" title="发表于 2022-12-31 16:58:24">2022-12-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/26/sbp-spriteatlas-bug/" title="UnitySBP打包SpriteAtlas图集时的纹理冗余Bug"><img src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/top_image.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="UnitySBP打包SpriteAtlas图集时的纹理冗余Bug"/></a><div class="content"><a class="title" href="/2022/11/26/sbp-spriteatlas-bug/" title="UnitySBP打包SpriteAtlas图集时的纹理冗余Bug">UnitySBP打包SpriteAtlas图集时的纹理冗余Bug</a><time datetime="2022-11-26T07:11:56.000Z" title="发表于 2022-11-26 15:11:56">2022-11-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/09/04/catasset-dev-summary-with-runtime/" title="CatAsset开发总结：Runtime篇"><img src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/CatAssetDevSummaryWithRuntime/CatAssetDevSummaryWithRuntime_01.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CatAsset开发总结：Runtime篇"/></a><div class="content"><a class="title" href="/2022/09/04/catasset-dev-summary-with-runtime/" title="CatAsset开发总结：Runtime篇">CatAsset开发总结：Runtime篇</a><time datetime="2022-09-04T00:56:01.000Z" title="发表于 2022-09-04 08:56:01">2022-09-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/09/01/catasset-dev-summary-with-editor/" title="CatAsset开发总结：Editor篇"><img src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/CatAssetDevSummaryWithEditor/CatAssetDevSummaryWithEditor_01.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CatAsset开发总结：Editor篇"/></a><div class="content"><a class="title" href="/2022/09/01/catasset-dev-summary-with-editor/" title="CatAsset开发总结：Editor篇">CatAsset开发总结：Editor篇</a><time datetime="2022-09-01T13:02:08.000Z" title="发表于 2022-09-01 21:02:08">2022-09-01</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2023 By 自然妙有猫仙人</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{
  const $countDom = document.getElementById('twikoo-count')
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo-weld.vercel.app/',
      region: ''
    }, null))
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'https://twikoo-weld.vercel.app/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      $countDom.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const loadTwikoo = (bool = false) => {
    if (typeof twikoo === 'object') {
      init()
      bool && $countDom && setTimeout(getCount,0)
    } else {
      getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(()=> {
        init()
        bool && $countDom && setTimeout(getCount,0)
      })
    }
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo(true)
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start -->
  <script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/hexo-github-calendar@1.21/hexo_githubcalendar.js"></script>
  <script data-pjax>
        function GithubCalendarConfig(){
            var git_githubapiurl ="https://python-github-calendar-api.vercel.app/api?CatImmortal";
            var git_color =['#ebedf0', '#fdcdec', '#fc9bd9', '#fa6ac5', '#f838b2', '#f5089f', '#c4067e', '#92055e', '#540336', '#48022f', '#30021f'];
            var git_user ="CatImmortal";
            var parent_div_git = document.getElementById('recent-posts');
            var git_div_html = '<div class="recent-post-item" style="width:100%;height:auto;padding:10px;"><div id="github_loading" style="width:10%;height:100%;margin:0 auto;display: block"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animateTransform></path></svg></div><div id="github_container"></div></div>';
            if(parent_div_git && location.pathname =='/'){
                console.log('已挂载github calendar')
                // parent_div_git.innerHTML=git_div_html+parent_div_git.innerHTML // 无报错，但不影响使用(支持pjax跳转)
                parent_div_git.insertAdjacentHTML("afterbegin",git_div_html) // 有报错，但不影响使用(支持pjax跳转)
            };
            GithubCalendar(git_githubapiurl,git_color,git_user)
        }
        if(document.getElementById('recent-posts')){
            GithubCalendarConfig()
        }
    </script>
    <style>#github_container{min-height:280px}@media screen and (max-width:650px) {#github_container{background-image:;min-height:0px}}</style>
    <style></style><!-- hexo injector body_end end --></body></html>