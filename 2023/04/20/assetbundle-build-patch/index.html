<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>在Unity中构建AssetBundle补丁包 | 仙猫洞</title><meta name="keywords" content="资源管理"><meta name="author" content="自然妙有猫仙人"><meta name="copyright" content="自然妙有猫仙人"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="如何仅构建发生了变化的资源">
<meta property="og:type" content="article">
<meta property="og:title" content="在Unity中构建AssetBundle补丁包">
<meta property="og:url" content="http://www.cathole.top/2023/04/20/assetbundle-build-patch/index.html">
<meta property="og:site_name" content="仙猫洞">
<meta property="og:description" content="如何仅构建发生了变化的资源">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/top_image.jpg">
<meta property="article:published_time" content="2023-04-20T13:04:54.000Z">
<meta property="article:modified_time" content="2023-06-24T04:45:54.803Z">
<meta property="article:author" content="自然妙有猫仙人">
<meta property="article:tag" content="资源管理">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/top_image.jpg"><link rel="shortcut icon" href="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/head2.png"><link rel="canonical" href="http://www.cathole.top/2023/04/20/assetbundle-build-patch/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '在Unity中构建AssetBundle补丁包',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-06-24 12:45:54'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom/copyright.css"><link rel="stylesheet" href="/css/custom/index.7dde3304.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/head2.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">24</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">9</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/top_image.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">仙猫洞</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">在Unity中构建AssetBundle补丁包</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-04-20T13:04:54.000Z" title="发表于 2023-04-20 21:04:54">2023-04-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-06-24T04:45:54.803Z" title="更新于 2023-06-24 12:45:54">2023-06-24</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%A8%8B%E5%BA%8F/">程序</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>17分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="在Unity中构建AssetBundle补丁包"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>前段时间隔壁项目组主程为了能更快速的打包项目里的<strong>AssetBundle</strong>，提了个增加补丁包构建的需求，于是费了几番功夫后便在<a target="_blank" rel="noopener" href="https://github.com/CatImmortal/CatAsset">CatAsset</a>中加入了此功能，这篇文章便用来记录此功能的实现思路</p>
<h1 id="何为补丁包"><a href="#何为补丁包" class="headerlink" title="何为补丁包"></a>何为补丁包</h1><p>首先需要明确几个<strong>AssetBundle</strong>构建相关的概念：</p>
<ol>
<li><strong>全量构建</strong>：将所有需要打包的资源提交给Unity的<strong>AssetBundle</strong>构建管线，然后Unity对所有<strong>AssetBundle</strong>全部进行重新构建<strong>（此构建方式很少被使用）</strong></li>
<li><strong>增量构建</strong>：将所有需要打包的资源提交给Unity的<strong>AssetBundle</strong>构建管线，然后Unity仅对发生了变化的<strong>AssetBundle</strong>进行重新构建<strong>（这是最常见的标准构建方式）</strong></li>
<li><strong>补丁构建</strong>：仅将发生了变化的资源及其相关资源提交给Unity的<strong>AssetBundle</strong>构建管线，然后由Unity进行<strong>AssetBundle</strong>构建</li>
</ol>
<p>所谓<strong>补丁包</strong>，即是补丁构建的产物</p>
<p>举例来说，若有<strong>资源a、b、c、d被打包为资源包A</strong>，<strong>e、f、g、h被打包为资源包B</strong>（这些资源之间没有依赖关系），且其中资源b发生了变化</p>
<p>那么在进行<strong>增量构建</strong>时，会将这8个资源全部提交给Unity底层的构建管线，然后Unity会将a、b、c、d所属的资源包A进行重新构建，资源包B则从缓存中复制</p>
<p>而如果进行的是<strong>补丁构建</strong>，那么只会将发生了变化的资源b提交给Unity单独打包为资源包A_patch，与资源包A、B共存，且后续在加载资源b时只会从A_patch中加载</p>
<h1 id="补丁构建的优缺点"><a href="#补丁构建的优缺点" class="headerlink" title="补丁构建的优缺点"></a>补丁构建的优缺点</h1><p>补丁构建的优点主要在于：</p>
<ol>
<li>资源数量庞大的时候可以很好的加快打包速度，节省时间，减少因为<strong>版本日打包导致的加班风险</strong>，</li>
<li>在进行资源更新时可以有效降低玩家需要更新的资源大小</li>
</ol>
<p>而其缺点则主要是：</p>
<ol>
<li>因为补丁包与正式包是共存的，所以会产生一定程度的资源冗余</li>
<li>补丁资源的计算基于与上一次完整打包（非补丁构建）产生的缓存信息的对比，所以随着变化的资源增多，会提交给Unity的资源数也会增多，构建速度也会逐渐趋近于完整打包的速度，这时需要通过重新进行一次新的完整打包来更新缓存信息</li>
</ol>
<h1 id="构建补丁包时要注意的地方"><a href="#构建补丁包时要注意的地方" class="headerlink" title="构建补丁包时要注意的地方"></a>构建补丁包时要注意的地方</h1><p>想要进行补丁包构建，首先需要记录上次完整打包的缓存信息，在CatAsset中是通过记录文件<strong>最后写入时间</strong>实现，但不仅仅是资源文件的最后写入时间，还需要包括资源文件对应的Meta文件的<strong>最后写入时间</strong>才行，否则会导致补丁资源计算出错，因为有些对资源的修改是被反应到Meta文件里的</p>
<p>另外在计算补丁资源时，不仅是需要判断资源自身是否有变化，还需要考虑它所依赖的资源是否为补丁资源，若它所依赖（直接或间接）的任意一个资源为补丁资源，则此资源也必须视为补丁资源处理（这就意味着<strong>补丁资源具有下游传染性</strong>，会传染给依赖链下游的所有资源），<strong>因为只有在同一批AssetBundle打包的资源之间才能正确进行互相的依赖引用</strong>，否则就会产生<strong>依赖补丁资源的资源，其依赖加载的是旧资源而非新的补丁资源</strong>的问题</p>
<p>对于补丁资源所依赖的资源，则采用隐式依赖自动包含的机制，不对其进行显式构建，且从补丁资源的依赖列表中移除，以此故意冗余一份相同的依赖资源到补丁资源所在的补丁包中，加载时让Unity自动加载，以保证正式包和补丁包的依赖到相同资源时都能被正确的加载到</p>
<p>举例来说，假设有依赖链为<strong>D -&gt; C -&gt; B -&gt; A</strong>和<strong>D -&gt; E</strong>，且C为变化的资源，那么最终会将<strong>C以及依赖C的B和A</strong>作为补丁资源，<strong>D作为C的隐式依赖</strong>包含进C的补丁包里，运行时<strong>E依赖的D和C依赖的D会分别在不同的包里</strong>保证E的依赖不丢失（因为在补丁构建后会将资源清单中的旧资源信息删除，保留新的补丁资源信息，以保证能加载到最新的补丁资源）</p>
<h1 id="构建补丁包的具体步骤"><a href="#构建补丁包的具体步骤" class="headerlink" title="构建补丁包的具体步骤"></a>构建补丁包的具体步骤</h1><p>CatAsset使用SBP进行AssetBundle构建，并自定义了一些构建任务来满足需求</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 构建资源包</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ReturnCode <span class="title">BuildBundles</span>(<span class="params">BuildTarget targetPlatform,<span class="built_in">bool</span> isBuildPatch</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">          BundleBuildConfigSO config = BundleBuildConfigSO.Instance;</span><br><span class="line">          </span><br><span class="line">          <span class="comment">//预处理</span></span><br><span class="line">          <span class="keyword">var</span> preData = <span class="keyword">new</span> BundleBuildPreProcessData</span><br><span class="line">          &#123;</span><br><span class="line">              Config = config,</span><br><span class="line">              TargetPlatform = targetPlatform</span><br><span class="line">          &#125;;</span><br><span class="line">          OnBundleBuildPreProcess(preData);</span><br><span class="line">          </span><br><span class="line">         </span><br><span class="line">          <span class="keyword">if</span> (isBuildPatch)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="comment">//检查构建补丁包的缓存文件是否存在</span></span><br><span class="line">              <span class="comment">//若不存在就进行完整资源包构建</span></span><br><span class="line">              <span class="built_in">string</span> manifestPath = EditorUtil.GetCacheManifestPath(config.OutputRootDirectory, targetPlatform);</span><br><span class="line">              <span class="built_in">string</span> assetCacheManifestPath = EditorUtil.GetAssetCacheManifestPath(config.OutputRootDirectory);</span><br><span class="line">              <span class="keyword">if</span> (!File.Exists(manifestPath) || !File.Exists(assetCacheManifestPath))</span><br><span class="line">              &#123;</span><br><span class="line">                  isBuildPatch = <span class="literal">false</span>;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          </span><br><span class="line">          <span class="comment">//准备参数</span></span><br><span class="line">          <span class="built_in">string</span> fullOutputFolder = CreateFullOutputFolder(config, targetPlatform);</span><br><span class="line">          BundleBuildInfoParam buildInfoParam = <span class="keyword">new</span> BundleBuildInfoParam();</span><br><span class="line">          BundleBuildConfigParam configParam = <span class="keyword">new</span> BundleBuildConfigParam(config, targetPlatform,isBuildPatch);</span><br><span class="line">          BundleBuildParameters buildParam = GetSBPParameters(config, targetPlatform, fullOutputFolder);</span><br><span class="line">          BundleBuildContent content = <span class="keyword">new</span> BundleBuildContent();</span><br><span class="line"></span><br><span class="line">          <span class="comment">//添加构建任务</span></span><br><span class="line">          List&lt;IBuildTask&gt; taskList = GetSBPInternalBuildTask(!isBuildPatch);</span><br><span class="line">          taskList.Insert(<span class="number">0</span>,<span class="keyword">new</span> CalculateBundleBuilds());</span><br><span class="line">          taskList.Add(<span class="keyword">new</span> BuildRawBundles());</span><br><span class="line">          taskList.Add(<span class="keyword">new</span> BuildManifest());</span><br><span class="line">          taskList.Add(<span class="keyword">new</span> EncryptBundles());</span><br><span class="line">          taskList.Add(<span class="keyword">new</span> CalculateVerifyInfo());</span><br><span class="line">          <span class="keyword">if</span> (HasOption(config.Options,BundleBuildOptions.AppendHash))</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="comment">//附加Hash到包名中</span></span><br><span class="line">              taskList.Add(<span class="keyword">new</span> AppendHash());</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (isBuildPatch)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="comment">//补丁包需要合并资源清单</span></span><br><span class="line">              taskList.Add(<span class="keyword">new</span> RemoveNonPatchDependency());</span><br><span class="line">              taskList.Add(<span class="keyword">new</span> MergePatchManifest());</span><br><span class="line">          &#125;</span><br><span class="line">          taskList.Add(<span class="keyword">new</span> WriteManifestFile());</span><br><span class="line">          <span class="keyword">if</span> (!isBuildPatch)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="comment">//非补丁包 写入缓存</span></span><br><span class="line">              taskList.Add(<span class="keyword">new</span> WriteCacheFile());</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (config.IsCopyToReadOnlyDirectory &amp;&amp; config.TargetPlatforms.Count == <span class="number">1</span>)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="comment">//需要复制资源包到只读目录下</span></span><br><span class="line">              taskList.Add(<span class="keyword">new</span> CopyToReadOnlyDirectory());</span><br><span class="line">              taskList.Add(<span class="keyword">new</span> WriteManifestFile());</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">//开始构建资源包</span></span><br><span class="line">          Stopwatch sw = Stopwatch.StartNew();</span><br><span class="line">          </span><br><span class="line">          <span class="comment">//调用SBP的构建管线</span></span><br><span class="line">          ReturnCode returnCode = ContentPipeline.BuildAssetBundles(buildParam, content,</span><br><span class="line">              <span class="keyword">out</span> IBundleBuildResults result, taskList, buildInfoParam,configParam);</span><br><span class="line"></span><br><span class="line">          <span class="comment">//检查结果</span></span><br><span class="line">          <span class="keyword">if</span> (returnCode == ReturnCode.Success)</span><br><span class="line">          &#123;</span><br><span class="line">              Debug.Log(<span class="string">$&quot;资源包构建成功:<span class="subst">&#123;returnCode&#125;</span>,耗时:<span class="subst">&#123;sw.Elapsed.Hours&#125;</span>时<span class="subst">&#123;sw.Elapsed.Minutes&#125;</span>分<span class="subst">&#123;sw.Elapsed.Seconds&#125;</span>秒&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">              Debug.LogError(<span class="string">$&quot;资源包构建未成功:<span class="subst">&#123;returnCode&#125;</span>,耗时:<span class="subst">&#123;sw.Elapsed.Hours&#125;</span>时<span class="subst">&#123;sw.Elapsed.Minutes&#125;</span>分<span class="subst">&#123;sw.Elapsed.Seconds&#125;</span>秒&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      </span><br><span class="line">          <span class="comment">//后处理</span></span><br><span class="line">          <span class="keyword">var</span> postData = <span class="keyword">new</span> BundleBuildPostProcessData</span><br><span class="line">          &#123;</span><br><span class="line">              Config = config,</span><br><span class="line">              TargetPlatform = targetPlatform,</span><br><span class="line">              OutputFolder = fullOutputFolder,</span><br><span class="line">              ReturnCode = returnCode,</span><br><span class="line">              Result = result,</span><br><span class="line">          &#125;;</span><br><span class="line">          OnBundleBuildPostProcess(postData);</span><br><span class="line">          </span><br><span class="line">          <span class="keyword">return</span> returnCode;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>



<p>总的来说，构建补丁包需要3个步骤：</p>
<ol>
<li>在进行完整构建时记录资源缓存信息</li>
<li>计算补丁资源</li>
<li>合并资源清单</li>
</ol>
<h2 id="生成完整构建时的资源缓存"><a href="#生成完整构建时的资源缓存" class="headerlink" title="生成完整构建时的资源缓存"></a>生成完整构建时的资源缓存</h2><p>资源缓存信息清单的类定义</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> CatAsset.Runtime;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CatAsset.Editor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 资源缓存清单</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AssetCacheManifest</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 资源缓存信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">Serializable</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">struct</span> AssetCacheInfo : IEquatable&lt;AssetCacheInfo&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> Name;</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">long</span> LastWriteTime;</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">long</span> MetaLastWriteTime;</span><br><span class="line">            </span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AssetCacheInfo <span class="title">Create</span>(<span class="params"><span class="built_in">string</span> assetName</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                AssetCacheInfo assetCacheInfo = <span class="keyword">new</span> AssetCacheInfo</span><br><span class="line">                &#123;</span><br><span class="line">                    Name = assetName,</span><br><span class="line">                    LastWriteTime = File.GetLastWriteTime(assetName).Ticks,</span><br><span class="line">                    MetaLastWriteTime =  File.GetLastWriteTime(<span class="string">$&quot;<span class="subst">&#123;assetName&#125;</span>.meta&quot;</span>).Ticks,</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">return</span> assetCacheInfo;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="keyword">operator</span> ==(AssetCacheInfo a,AssetCacheInfo b)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> Equals(a, b);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="keyword">operator</span> !=(AssetCacheInfo a,AssetCacheInfo b)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> !(a == b);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">Equals</span>(<span class="params">AssetCacheInfo other</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> Name == other.Name &amp;&amp; LastWriteTime == other.LastWriteTime &amp;&amp; MetaLastWriteTime == other.MetaLastWriteTime;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">Equals</span>(<span class="params"><span class="built_in">object</span> obj</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> obj <span class="keyword">is</span> AssetCacheInfo other &amp;&amp; Equals(other);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">int</span> <span class="title">GetHashCode</span>(<span class="params"></span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">unchecked</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> hashCode = (Name != <span class="literal">null</span> ? Name.GetHashCode() : <span class="number">0</span>);</span><br><span class="line">                    hashCode = (hashCode * <span class="number">397</span>) ^ LastWriteTime.GetHashCode();</span><br><span class="line">                    hashCode = (hashCode * <span class="number">397</span>) ^ MetaLastWriteTime.GetHashCode();</span><br><span class="line">                    <span class="keyword">return</span> hashCode;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 资源清单Json文件名</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> ManifestJsonFileName = <span class="string">&quot;AssetCacheManifest.json&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">List</span>&lt;<span class="title">AssetCacheInfo</span>&gt; Caches</span> = <span class="keyword">new</span> List&lt;AssetCacheInfo&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Dictionary&lt;<span class="built_in">string</span>, AssetCacheInfo&gt; <span class="title">GetCacheDict</span>(<span class="params"></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Dictionary&lt;<span class="built_in">string</span>, AssetCacheInfo&gt; result = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, AssetCacheInfo&gt;();</span><br><span class="line">            <span class="keyword">foreach</span> (AssetCacheInfo assetCache <span class="keyword">in</span> Caches)</span><br><span class="line">            &#123;</span><br><span class="line">                result.Add(assetCache.Name,assetCache);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正如之前提到的，除了资源文件本身的<strong>最后写入时间</strong>外还需要记录Meta文件的<strong>最后写入时间</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> CatAsset.Runtime;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEditor.Build.Pipeline;</span><br><span class="line"><span class="keyword">using</span> UnityEditor.Build.Pipeline.Injector;</span><br><span class="line"><span class="keyword">using</span> UnityEditor.Build.Pipeline.Interfaces;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CatAsset.Editor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 写入缓存文件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">WriteCacheFile</span> : <span class="title">IBuildTask</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">InjectContext(ContextUsage.In)</span>]</span><br><span class="line">        <span class="keyword">private</span> IBundleBuildConfigParam configParam;</span><br><span class="line">        </span><br><span class="line">        [<span class="meta">InjectContext(ContextUsage.In)</span>]</span><br><span class="line">        <span class="keyword">private</span> IManifestParam manifestParam;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">InjectContext(ContextUsage.In)</span>] </span><br><span class="line">        <span class="keyword">private</span> IBundleBuildParameters buildParam;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Version &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">public</span> ReturnCode <span class="title">Run</span>(<span class="params"></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//复制资源包构建输出结果到缓存文件夹中</span></span><br><span class="line">            <span class="built_in">string</span> folder = EditorUtil.GetBundleCacheFolder(configParam.Config.OutputRootDirectory,</span><br><span class="line">                configParam.TargetPlatform);</span><br><span class="line">            EditorUtil.CreateEmptyDirectory(folder);</span><br><span class="line">            EditorUtil.CopyDirectory(((BundleBuildParameters)buildParam).OutputFolder,folder);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//写入资源缓存清单</span></span><br><span class="line">            folder = EditorUtil.GetAssetCacheManifestFolder(configParam.Config.OutputRootDirectory);</span><br><span class="line">            EditorUtil.CreateEmptyDirectory(folder);</span><br><span class="line">            AssetCacheManifest assetCacheManifest = <span class="keyword">new</span> AssetCacheManifest();</span><br><span class="line">            <span class="keyword">foreach</span> (BundleManifestInfo bundleManifestInfo <span class="keyword">in</span> manifestParam.Manifest.Bundles)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (AssetManifestInfo assetManifestInfo <span class="keyword">in</span> bundleManifestInfo.Assets)</span><br><span class="line">                &#123;</span><br><span class="line">                    AssetCacheManifest.AssetCacheInfo cacheInfo = AssetCacheManifest.AssetCacheInfo.Create(assetManifestInfo.Name);</span><br><span class="line">                    assetCacheManifest.Caches.Add(cacheInfo);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">string</span> json = EditorJsonUtility.ToJson(assetCacheManifest,<span class="literal">true</span>);</span><br><span class="line">            <span class="built_in">string</span> path = RuntimeUtil.GetRegularPath(Path.Combine(folder, AssetCacheManifest.ManifestJsonFileName));</span><br><span class="line">            <span class="keyword">using</span> (StreamWriter sw = <span class="keyword">new</span> StreamWriter(path))</span><br><span class="line">            &#123;</span><br><span class="line">                sw.Write(json);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> ReturnCode.Success;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除了记录资源<strong>最后写入时间</strong>外，还需要将完整构建产出的资源包复制到资源包缓存目录下，用于在补丁构建后进行合并形成最终的完整资源包输出</p>
<h2 id="计算补丁资源"><a href="#计算补丁资源" class="headerlink" title="计算补丁资源"></a>计算补丁资源</h2><p>补丁资源的计算大致由以下步骤组成：</p>
<ol>
<li>判断自身是否变化</li>
<li>判断自身依赖的资源是否为补丁资源</li>
</ol>
<p>判断【资源是否变化】的步骤则为：</p>
<ol>
<li>是否为新资源</li>
<li>是否为变化的旧资源</li>
<li>是否为被移动到新包里的旧资源</li>
</ol>
<p>具体代码如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> CatAsset.Runtime;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEditor.Build.Pipeline;</span><br><span class="line"><span class="keyword">using</span> UnityEditor.Build.Pipeline.Injector;</span><br><span class="line"><span class="keyword">using</span> UnityEditor.Build.Pipeline.Interfaces;</span><br><span class="line"><span class="keyword">using</span> UnityEditor.Build.Pipeline.Utilities;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> Debug = UnityEngine.Debug;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CatAsset.Editor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 计算资源包构建信息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CalculateBundleBuilds</span> : <span class="title">IBuildTask</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Version &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        [<span class="meta">InjectContext(ContextUsage.In)</span>] </span><br><span class="line">        <span class="keyword">private</span> IBundleBuildParameters buildParam;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">InjectContext(ContextUsage.InOut)</span>] </span><br><span class="line">        <span class="keyword">private</span> IBundleBuildInfoParam buildInfoParam;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">InjectContext(ContextUsage.In)</span>] </span><br><span class="line">        <span class="keyword">private</span> IBundleBuildConfigParam configParam;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">InjectContext(ContextUsage.In)</span>] </span><br><span class="line">        <span class="keyword">private</span> IBuildCache buildCache;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">InjectContext(ContextUsage.InOut)</span>] </span><br><span class="line">        <span class="keyword">private</span> IBundleBuildContent content;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">InjectContext(ContextUsage.InOut)</span>] </span><br><span class="line">        <span class="keyword">private</span> IBuildContent content2;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ReturnCode <span class="title">Run</span>(<span class="params"></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            BundleBuildConfigSO config = configParam.Config;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!configParam.IsBuildPatch)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//构建完整资源包</span></span><br><span class="line">                buildInfoParam = <span class="keyword">new</span> BundleBuildInfoParam(config.GetAssetBundleBuilds(), config.GetNormalBundleBuilds(),</span><br><span class="line">                    config.GetRawBundleBuilds());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//构建补丁资源包</span></span><br><span class="line">                Stopwatch sw = Stopwatch.StartNew();</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">var</span> clonedConfig = <span class="keyword">new</span> PatchAssetCalculateHelper().Calculate(config, configParam.TargetPlatform);</span><br><span class="line"></span><br><span class="line">                sw.Stop();</span><br><span class="line">                Debug.Log(<span class="string">$&quot;计算补丁资源耗时:<span class="subst">&#123;sw.Elapsed.TotalSeconds:<span class="number">0.00</span>&#125;</span>秒&quot;</span>);</span><br><span class="line">                </span><br><span class="line">                buildInfoParam = <span class="keyword">new</span> BundleBuildInfoParam(clonedConfig.GetAssetBundleBuilds(),</span><br><span class="line">                    clonedConfig.GetNormalBundleBuilds(),</span><br><span class="line">                    clonedConfig.GetRawBundleBuilds());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ((BundleBuildParameters)buildParam).SetBundleBuilds(buildInfoParam.NormalBundleBuilds);</span><br><span class="line">            content = <span class="keyword">new</span> BundleBuildContent(buildInfoParam.AssetBundleBuilds);</span><br><span class="line">            content2 = content;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> ReturnCode.Success;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> CatAsset.Runtime;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CatAsset.Editor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 补丁资源计算辅助类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PatchAssetCalculateHelper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//上游依赖记录</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">Dictionary</span>&lt;<span class="title">string</span>, <span class="title">List</span>&lt;<span class="title">string</span>&gt;&gt; upStreamDict</span> = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, List&lt;<span class="built_in">string</span>&gt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//资源名 -&gt; 本次构建时所属的资源包名</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">Dictionary</span>&lt;<span class="title">string</span>, <span class="title">string</span>&gt; assetToBundle</span> = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//资源名 -&gt; 上次完整构建时所属的资源包名</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">Dictionary</span>&lt;<span class="title">string</span>, <span class="title">string</span>&gt; cacheAssetToBundle</span> = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;();</span><br><span class="line">                </span><br><span class="line">        <span class="comment">//读取上次完整构建时的资源缓存清单</span></span><br><span class="line">        <span class="keyword">private</span> AssetCacheManifest assetCacheManifest;</span><br><span class="line">                </span><br><span class="line">        <span class="comment">//资源名 -&gt; 上次完整构建时的资源缓存信息</span></span><br><span class="line">        <span class="keyword">private</span> Dictionary&lt;<span class="built_in">string</span>, AssetCacheManifest.AssetCacheInfo&gt; assetCacheDict;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//资源名 -&gt; 当前资源缓存信息</span></span><br><span class="line">        <span class="keyword">private</span> Dictionary&lt;<span class="built_in">string</span>, AssetCacheManifest.AssetCacheInfo&gt; curAssetCacheDict =</span><br><span class="line">            <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, AssetCacheManifest.AssetCacheInfo&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//资源名 -&gt; 是否已变化</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">Dictionary</span>&lt;<span class="title">string</span>, <span class="title">bool</span>&gt; assetChangeStateDict</span> = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">bool</span>&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//资源名 -&gt; 是否为补丁资源</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">Dictionary</span>&lt;<span class="title">string</span>, <span class="title">bool</span>&gt; assetPatchStateDict</span> = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">bool</span>&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">public</span> BundleBuildConfigSO <span class="title">Calculate</span>(<span class="params">BundleBuildConfigSO config, BuildTarget buildTarget</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            assetCacheManifest = ReadAssetCache(config);</span><br><span class="line">            assetCacheDict = assetCacheManifest.GetCacheDict();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//深拷贝一份构建配置进行操作</span></span><br><span class="line">            BundleBuildConfigSO clonedConfig = Object.Instantiate(config);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//获取依赖</span></span><br><span class="line">            GetDependencyChain(config);</span><br><span class="line">                </span><br><span class="line">            <span class="comment">//读取上次完整构建时的资源包信息</span></span><br><span class="line">            ReadCachedManifest(config,buildTarget);</span><br><span class="line">                </span><br><span class="line">            <span class="comment">//计算补丁资源</span></span><br><span class="line">            CalPatchAsset(config, clonedConfig);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> clonedConfig;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//省略...</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 计算补丁资源</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CalPatchAsset</span>(<span class="params">BundleBuildConfigSO config, BundleBuildConfigSO clonedConfig</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> index = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = clonedConfig.Bundles.Count - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> bundle = clonedConfig.Bundles[i];</span><br><span class="line"></span><br><span class="line">                <span class="comment">//此资源包是否全部资源都是补丁资源</span></span><br><span class="line">                <span class="built_in">bool</span> isAllPatch = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> j = bundle.Assets.Count - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> asset = bundle.Assets[j];</span><br><span class="line">                    index++;</span><br><span class="line">                    EditorUtility.DisplayProgressBar(<span class="string">$&quot;计算补丁资源&quot;</span>, <span class="string">$&quot;<span class="subst">&#123;asset.Name&#125;</span>&quot;</span>, index / (config.AssetCount * <span class="number">1.0f</span>));</span><br><span class="line">                    </span><br><span class="line">                    <span class="built_in">bool</span> isPatch = IsPatchAsset(asset.Name);</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (isPatch)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Debug.Log(<span class="string">$&quot;发现补丁资源:<span class="subst">&#123;asset.Name&#125;</span>&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">//不是补丁资源 移除掉</span></span><br><span class="line">                        bundle.Assets.RemoveAt(j);</span><br><span class="line">                        isAllPatch = <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (bundle.Assets.Count &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//是补丁包</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (!isAllPatch)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">//有部分资源不是补丁资源 需要改名 否则直接用正式包的名字了</span></span><br><span class="line">                        <span class="keyword">var</span> part = bundle.BundleName.Split(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">                        bundle.BundleName = <span class="string">$&quot;<span class="subst">&#123;part[<span class="number">0</span>]&#125;</span>_patch.<span class="subst">&#123;part[<span class="number">1</span>]&#125;</span>&quot;</span>;</span><br><span class="line">                        bundle.BundleIdentifyName =</span><br><span class="line">                            BundleBuildInfo.GetBundleIdentifyName(bundle.DirectoryName, bundle.BundleName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//不是补丁包 需要移除</span></span><br><span class="line">                    clonedConfig.Bundles.RemoveAt(i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            EditorUtility.ClearProgressBar();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 是否为补丁资源</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">IsPatchAsset</span>(<span class="params"><span class="built_in">string</span> assetName</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//0.已经计算过状态了</span></span><br><span class="line">            <span class="keyword">if</span> (assetPatchStateDict.TryGetValue(assetName, <span class="keyword">out</span> <span class="built_in">bool</span> isPatch))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> isPatch;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//1.自身是否已变化</span></span><br><span class="line">            isPatch = IsChangedAsset(assetName);</span><br><span class="line">            <span class="keyword">if</span> (isPatch)</span><br><span class="line">            &#123;</span><br><span class="line">                assetPatchStateDict.Add(assetName,<span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//2.此资源依赖的上游资源是否为补丁资源</span></span><br><span class="line">            <span class="comment">//位于上游的补丁资源，其补丁性会传染给依赖链下游的所有资源</span></span><br><span class="line">            <span class="keyword">if</span> (upStreamDict.TryGetValue(assetName, <span class="keyword">out</span> <span class="keyword">var</span> upStreamList))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="built_in">string</span> upStream <span class="keyword">in</span> upStreamList)</span><br><span class="line">                &#123;</span><br><span class="line">                    isPatch = IsPatchAsset(upStream);</span><br><span class="line">                    <span class="keyword">if</span> (isPatch)</span><br><span class="line">                    &#123;</span><br><span class="line">                        assetPatchStateDict.Add(assetName,<span class="literal">true</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//补丁性不传染给依赖链上游资源</span></span><br><span class="line">            <span class="comment">//而是通过隐式依赖自动包含机制 故意冗余一份 使得补丁资源的依赖和它本身在一个资源包内</span></span><br><span class="line">            <span class="comment">//以防止正式包的资源 依赖到 补丁包依赖的资源 时 丢失依赖</span></span><br><span class="line">            <span class="comment">//这样就会在正式包和补丁包里各包含一份相同的依赖资源 保证正式包依赖不丢失</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//假设有D -&gt; C -&gt; B -&gt; A 和 D -&gt; E 的依赖链，且C为变化的资源</span></span><br><span class="line">            <span class="comment">//那么最终会将C以及依赖C的B和A作为补丁资源，D作为C的隐式依赖包含进C的补丁包里</span></span><br><span class="line">            <span class="comment">//运行时 E依赖的D 和 C依赖的D 会分别在不同的包里 保证E依赖不丢失</span></span><br><span class="line">            </span><br><span class="line">            assetPatchStateDict.Add(assetName,<span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 是否为已变化的资源</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">IsChangedAsset</span>(<span class="params"><span class="built_in">string</span> assetName</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//0.已经计算过状态了</span></span><br><span class="line">            <span class="keyword">if</span> (assetChangeStateDict.TryGetValue(assetName, <span class="keyword">out</span> <span class="built_in">bool</span> isPatch))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> isPatch;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//1.新资源 </span></span><br><span class="line">            <span class="keyword">if</span> (!assetCacheDict.TryGetValue(assetName, <span class="keyword">out</span> <span class="keyword">var</span> assetCache))</span><br><span class="line">            &#123;</span><br><span class="line">                assetChangeStateDict.Add(assetName, <span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//2.变化的旧资源</span></span><br><span class="line">            <span class="keyword">if</span> (!curAssetCacheDict.TryGetValue(assetName, <span class="keyword">out</span> <span class="keyword">var</span> curAssetCache))</span><br><span class="line">            &#123;</span><br><span class="line">                curAssetCache = AssetCacheManifest.AssetCacheInfo.Create(assetName);</span><br><span class="line">                curAssetCacheDict.Add(assetName, curAssetCache);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (curAssetCache != assetCache)</span><br><span class="line">            &#123;</span><br><span class="line">                assetChangeStateDict.Add(assetName, <span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//3.被移动到新包的旧资源</span></span><br><span class="line">            <span class="keyword">if</span> (assetToBundle[assetName] != cacheAssetToBundle[assetName])</span><br><span class="line">            &#123;</span><br><span class="line">                assetChangeStateDict.Add(assetName, <span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//未变化</span></span><br><span class="line">            assetChangeStateDict.Add(assetName, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>上述代码会在完整构建的资源列表基础上，移除所有非补丁资源，以及不包含补丁资源的资源包，以此形成用于最终补丁构建的资源列表</p>
<p>另外值得一提的是，为了降低补丁包带来的复杂度与资源冗余，CatAsset规定了每个正式包最多只会有一个补丁包，同时如果某个补丁包包含了正式包的所有资源，则此补丁包会自动转正为正式包</p>
<h2 id="合并资源清单"><a href="#合并资源清单" class="headerlink" title="合并资源清单"></a>合并资源清单</h2><p>在构建补丁包完成后，需要将新的补丁资源包与上一次完整构建时输出的资源包进行合并，以得到最终输出的完整资源包与资源清单</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> CatAsset.Runtime;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEditor.Build.Pipeline;</span><br><span class="line"><span class="keyword">using</span> UnityEditor.Build.Pipeline.Injector;</span><br><span class="line"><span class="keyword">using</span> UnityEditor.Build.Pipeline.Interfaces;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CatAsset.Editor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 合并补丁包资源清单</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MergePatchManifest</span> : <span class="title">IBuildTask</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">InjectContext(ContextUsage.In)</span>]</span><br><span class="line">        <span class="keyword">private</span> IBundleBuildParameters buildParam;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">InjectContext(ContextUsage.In)</span>]</span><br><span class="line">        <span class="keyword">private</span> IBundleBuildConfigParam configParam;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">InjectContext(ContextUsage.InOut)</span>]</span><br><span class="line">        <span class="keyword">private</span> IManifestParam manifestParam;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;inheritdoc /&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Version =&gt; <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;inheritdoc /&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ReturnCode <span class="title">Run</span>(<span class="params"></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> config = configParam.Config;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">var</span> bundleCacheFolder = EditorUtil.GetBundleCacheFolder(config.OutputRootDirectory, configParam.TargetPlatform);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//本次补丁包构建的资源</span></span><br><span class="line">            HashSet&lt;<span class="built_in">string</span>&gt; patchAssets = <span class="keyword">new</span> HashSet&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">            <span class="keyword">foreach</span> (BundleManifestInfo bundleManifestInfo <span class="keyword">in</span> manifestParam.Manifest.Bundles)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (AssetManifestInfo assetManifestInfo <span class="keyword">in</span> bundleManifestInfo.Assets)</span><br><span class="line">                &#123;</span><br><span class="line">                    patchAssets.Add(assetManifestInfo.Name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//修改资源清单 移除重复资源</span></span><br><span class="line">            <span class="built_in">string</span> path = RuntimeUtil.GetRegularPath(Path.Combine(bundleCacheFolder, CatAssetManifest.ManifestJsonFileName));</span><br><span class="line">            CatAssetManifest cachedManifest = CatAssetManifest.DeserializeFromJson(File.ReadAllText(path));</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = cachedManifest.Bundles.Count - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">            &#123;</span><br><span class="line">                BundleManifestInfo bundleManifestInfo = cachedManifest.Bundles[i];</span><br><span class="line">                <span class="keyword">if</span> (bundleManifestInfo.BundleName == RuntimeUtil.BuiltInShaderBundleName)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//跳过内置Shader资源包</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> j = bundleManifestInfo.Assets.Count - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//删掉已经在补丁包中的资源信息</span></span><br><span class="line">                    AssetManifestInfo assetManifestInfo = bundleManifestInfo.Assets[j];</span><br><span class="line">                    <span class="keyword">if</span> (patchAssets.Contains(assetManifestInfo.Name))</span><br><span class="line">                    &#123;</span><br><span class="line">                        bundleManifestInfo.Assets.RemoveAt(j);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (bundleManifestInfo.Assets.Count == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//删掉所有资源都在补丁包里的资源包</span></span><br><span class="line">                    cachedManifest.Bundles.RemoveAt(i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//合并资源包</span></span><br><span class="line">            <span class="built_in">string</span> outputFolder = ((BundleBuildParameters)buildParam).OutputFolder;</span><br><span class="line">            <span class="keyword">foreach</span> (BundleManifestInfo bundleManifestInfo <span class="keyword">in</span> cachedManifest.Bundles)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> sourcePath = RuntimeUtil.GetRegularPath(Path.Combine(bundleCacheFolder, bundleManifestInfo.RelativePath));</span><br><span class="line">                <span class="built_in">string</span> destPath = RuntimeUtil.GetRegularPath(Path.Combine(outputFolder,bundleManifestInfo.RelativePath));</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(bundleManifestInfo.Directory))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">string</span> fullDirectory = RuntimeUtil.GetRegularPath(Path.Combine(outputFolder,bundleManifestInfo.Directory));</span><br><span class="line">                    <span class="keyword">if</span> (!Directory.Exists(fullDirectory))</span><br><span class="line">                    &#123;</span><br><span class="line">                        Directory.CreateDirectory(fullDirectory);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                File.Copy(sourcePath,destPath);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//合并补丁包资源清单与缓存资源清单</span></span><br><span class="line">            cachedManifest.Bundles.AddRange(manifestParam.Manifest.Bundles);</span><br><span class="line">            manifestParam = <span class="keyword">new</span> ManifestParam(cachedManifest, manifestParam.WriteFolder);</span><br><span class="line">            </span><br><span class="line">          </span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> ReturnCode.Success;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此操作会将在原来被缓存的资源清单中存在的补丁资源， 以及所有资源都是补丁资源的资源包从原资源清单中移除，然后与补丁构建产生的资源清单合并，最终得到一份新的资源清单用于正确的初始化资源信息</p>
<p>以之前的例子来说，补丁构建产生的资源清单只会包含A_patch和资源b的信息，并且会将原资源清单中的资源b信息移除，然后将二者进行合并以得到新的资源清单</p>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>在Unity中构建AssetBundle补丁包</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="http://www.cathole.top/2023/04/20/assetbundle-build-patch/">http://www.cathole.top/2023/04/20/assetbundle-build-patch/</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a" style="display: inline-block;width: 120px"><h>作者</h><div class="post-copyright-cc-info"><h>自然妙有猫仙人</h></div></div><div class="post-copyright-c" style="display: inline-block;width: 120px"><h>发布于</h><div class="post-copyright-cc-info"><h>2023-04-20</h></div></div><div class="post-copyright-u" style="display: inline-block;width: 120px"><h>更新于</h><div class="post-copyright-cc-info"><h>2023-06-24</h></div></div><div class="post-copyright-c" style="display: inline-block;width: 120px"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY 4.0" href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC BY 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/">资源管理</a></div><div class="post_share"><div class="social-share" data-image="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/top_image.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2022/12/31/2022-year-end-summary/"><img class="next-cover" src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/top_image.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">2022年终总结</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/09/01/catasset-dev-summary-with-editor/" title="CatAsset开发总结：Editor篇"><img class="cover" src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/CatAssetDevSummaryWithEditor/CatAssetDevSummaryWithEditor_01.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-01</div><div class="title">CatAsset开发总结：Editor篇</div></div></a></div><div><a href="/2022/08/30/catasset-guide/" title="CatAsset使用教程"><img class="cover" src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/top_image.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-30</div><div class="title">CatAsset使用教程</div></div></a></div><div><a href="/2022/09/04/catasset-dev-summary-with-runtime/" title="CatAsset开发总结：Runtime篇"><img class="cover" src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/CatAssetDevSummaryWithRuntime/CatAssetDevSummaryWithRuntime_01.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-04</div><div class="title">CatAsset开发总结：Runtime篇</div></div></a></div><div><a href="/2021/10/29/dependency-manage-compare/" title="Unity资源框架设计中不同级别依赖管理的对比"><img class="cover" src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/DependencyManageCompare/DependencyManageCompare_4.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-29</div><div class="title">Unity资源框架设计中不同级别依赖管理的对比</div></div></a></div><div><a href="/2022/11/26/sbp-spriteatlas-bug/" title="UnitySBP打包SpriteAtlas图集时的纹理冗余Bug"><img class="cover" src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/top_image.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-26</div><div class="title">UnitySBP打包SpriteAtlas图集时的纹理冗余Bug</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/head2.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">自然妙有猫仙人</div><div class="author-info__description">一个爱摸鱼的游戏程序员</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">24</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">9</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/CatImmortal" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:1304085906@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="tencent://message/?uin=1304085906&amp;Site=Sambow&amp;Menu=yes" target="_blank" title="QQ"><i class="fab fa-qq"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">QQ交流群：762036315</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%95%E4%B8%BA%E8%A1%A5%E4%B8%81%E5%8C%85"><span class="toc-number">2.</span> <span class="toc-text">何为补丁包</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A1%A5%E4%B8%81%E6%9E%84%E5%BB%BA%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-number">3.</span> <span class="toc-text">补丁构建的优缺点</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E8%A1%A5%E4%B8%81%E5%8C%85%E6%97%B6%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E5%9C%B0%E6%96%B9"><span class="toc-number">4.</span> <span class="toc-text">构建补丁包时要注意的地方</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E8%A1%A5%E4%B8%81%E5%8C%85%E7%9A%84%E5%85%B7%E4%BD%93%E6%AD%A5%E9%AA%A4"><span class="toc-number">5.</span> <span class="toc-text">构建补丁包的具体步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%AE%8C%E6%95%B4%E6%9E%84%E5%BB%BA%E6%97%B6%E7%9A%84%E8%B5%84%E6%BA%90%E7%BC%93%E5%AD%98"><span class="toc-number">5.1.</span> <span class="toc-text">生成完整构建时的资源缓存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E8%A1%A5%E4%B8%81%E8%B5%84%E6%BA%90"><span class="toc-number">5.2.</span> <span class="toc-text">计算补丁资源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%88%E5%B9%B6%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95"><span class="toc-number">5.3.</span> <span class="toc-text">合并资源清单</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/04/20/assetbundle-build-patch/" title="在Unity中构建AssetBundle补丁包"><img src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/top_image.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="在Unity中构建AssetBundle补丁包"/></a><div class="content"><a class="title" href="/2023/04/20/assetbundle-build-patch/" title="在Unity中构建AssetBundle补丁包">在Unity中构建AssetBundle补丁包</a><time datetime="2023-04-20T13:04:54.000Z" title="发表于 2023-04-20 21:04:54">2023-04-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/12/31/2022-year-end-summary/" title="2022年终总结"><img src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/top_image.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2022年终总结"/></a><div class="content"><a class="title" href="/2022/12/31/2022-year-end-summary/" title="2022年终总结">2022年终总结</a><time datetime="2022-12-31T08:58:24.000Z" title="发表于 2022-12-31 16:58:24">2022-12-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/26/sbp-spriteatlas-bug/" title="UnitySBP打包SpriteAtlas图集时的纹理冗余Bug"><img src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/top_image.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="UnitySBP打包SpriteAtlas图集时的纹理冗余Bug"/></a><div class="content"><a class="title" href="/2022/11/26/sbp-spriteatlas-bug/" title="UnitySBP打包SpriteAtlas图集时的纹理冗余Bug">UnitySBP打包SpriteAtlas图集时的纹理冗余Bug</a><time datetime="2022-11-26T07:11:56.000Z" title="发表于 2022-11-26 15:11:56">2022-11-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/09/04/catasset-dev-summary-with-runtime/" title="CatAsset开发总结：Runtime篇"><img src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/CatAssetDevSummaryWithRuntime/CatAssetDevSummaryWithRuntime_01.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CatAsset开发总结：Runtime篇"/></a><div class="content"><a class="title" href="/2022/09/04/catasset-dev-summary-with-runtime/" title="CatAsset开发总结：Runtime篇">CatAsset开发总结：Runtime篇</a><time datetime="2022-09-04T00:56:01.000Z" title="发表于 2022-09-04 08:56:01">2022-09-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/09/01/catasset-dev-summary-with-editor/" title="CatAsset开发总结：Editor篇"><img src="https://cathole-1307936347.cos.ap-guangzhou.myqcloud.com/CatAssetDevSummaryWithEditor/CatAssetDevSummaryWithEditor_01.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CatAsset开发总结：Editor篇"/></a><div class="content"><a class="title" href="/2022/09/01/catasset-dev-summary-with-editor/" title="CatAsset开发总结：Editor篇">CatAsset开发总结：Editor篇</a><time datetime="2022-09-01T13:02:08.000Z" title="发表于 2022-09-01 21:02:08">2022-09-01</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2023 By 自然妙有猫仙人</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{
  const $countDom = document.getElementById('twikoo-count')
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo-weld.vercel.app/',
      region: ''
    }, null))
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'https://twikoo-weld.vercel.app/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      $countDom.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const loadTwikoo = (bool = false) => {
    if (typeof twikoo === 'object') {
      init()
      bool && $countDom && setTimeout(getCount,0)
    } else {
      getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(()=> {
        init()
        bool && $countDom && setTimeout(getCount,0)
      })
    }
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo(true)
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start -->
  <script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/hexo-github-calendar@1.21/hexo_githubcalendar.js"></script>
  <script data-pjax>
        function GithubCalendarConfig(){
            var git_githubapiurl ="https://python-github-calendar-api.vercel.app/api?CatImmortal";
            var git_color =['#ebedf0', '#fdcdec', '#fc9bd9', '#fa6ac5', '#f838b2', '#f5089f', '#c4067e', '#92055e', '#540336', '#48022f', '#30021f'];
            var git_user ="CatImmortal";
            var parent_div_git = document.getElementById('recent-posts');
            var git_div_html = '<div class="recent-post-item" style="width:100%;height:auto;padding:10px;"><div id="github_loading" style="width:10%;height:100%;margin:0 auto;display: block"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animateTransform></path></svg></div><div id="github_container"></div></div>';
            if(parent_div_git && location.pathname =='/'){
                console.log('已挂载github calendar')
                // parent_div_git.innerHTML=git_div_html+parent_div_git.innerHTML // 无报错，但不影响使用(支持pjax跳转)
                parent_div_git.insertAdjacentHTML("afterbegin",git_div_html) // 有报错，但不影响使用(支持pjax跳转)
            };
            GithubCalendar(git_githubapiurl,git_color,git_user)
        }
        if(document.getElementById('recent-posts')){
            GithubCalendarConfig()
        }
    </script>
    <style>#github_container{min-height:280px}@media screen and (max-width:650px) {#github_container{background-image:;min-height:0px}}</style>
    <style></style><!-- hexo injector body_end end --></body></html>